<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HOR Barber">
    <meta name="theme-color" content="#FA383E">
    <title>HOR Barber App</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/Images/hor-barber-logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/Images/hor-barber-logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/Images/hor-barber-logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/Images/hor-barber-logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/Images/hor-barber-logo.png">
    <link rel="apple-touch-icon" href="/Images/hor-barber-logo.png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet"/>
    
    <!-- React Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ef4444",
                        "background-light": "#f8f7f5",
                        "background-dark": "#000000",
                        "surface-dark": "#1e293b",
                        "surface-light": "#ffffff",
                        "text-secondary": "#94a3b8",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.375rem", 
                        "lg": "0.5rem", 
                        "xl": "0.75rem", 
                        "2xl": "1rem",
                        "3xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
        
        .material-symbols-outlined.filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white antialiased selection:bg-primary selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;
        const { createRoot } = ReactDOM;

        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyArt0kPwFcdkgYMsHItrhDsOQheEfcUPDg",
            authDomain: "barberapp-2792d.firebaseapp.com",
            projectId: "barberapp-2792d",
            storageBucket: "barberapp-2792d.firebasestorage.app",
            messagingSenderId: "752240948229",
            appId: "1:752240948229:web:77faf5021a02742717586c",
            measurementId: "G-RZZDNG6T94"
        };

        // Initialize Firebase
        let db = null;
        let auth = null;
        let useFirebase = false;

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            auth = firebase.auth();
            useFirebase = true;
            console.log('âœ… Firebase initialized successfully');
        } catch (error) {
            console.warn('âš ï¸ Firebase not configured. Using localStorage fallback.', error.message);
            useFirebase = false;
        }

        // ============================================
        // FIREBASE HELPER FUNCTIONS
        // ============================================
        const FirebaseService = {
            scope: null, // The current barbershop ID
            
            setScope(barbershopId) {
                this.scope = barbershopId;
                // Update localStorage key prefix to keep local data separated too
                this.localPrefix = `barberapp_${barbershopId}_`;
                console.log(`ðŸ”’ Data scope set to: barbershops/${barbershopId}`);
            },

            // Helper to get collection reference typically scoped to the barbershop
            getCollectionRef(collectionName) {
                if (!useFirebase || !db) return null;
                if (!this.scope && collectionName !== 'users' && collectionName !== 'barbershops') {
                   console.error("âš ï¸ Attempting to access data without a barbershop scope!");
                   return null; 
                }
                
                // Global collections (if any)
                if (collectionName === 'users') return db.collection('users');
                
                // Scoped collections
                return db.collection('barbershops').doc(this.scope).collection(collectionName);
            },

            // Get collection data
            async getCollection(collectionName) {
                if (!this.scope) return [];

                // Try localStorage first (scoped)
                const localData = localStorage.getItem(`${this.localPrefix}${collectionName}`);
                let parsedLocal = [];
                try {
                    parsedLocal = localData ? JSON.parse(localData) : [];
                } catch (e) {
                    parsedLocal = [];
                }
                
                if (!Array.isArray(parsedLocal)) parsedLocal = [];
                
                if (!useFirebase) {
                    return parsedLocal;
                }

                try {
                    const colRef = this.getCollectionRef(collectionName);
                    if (!colRef) return parsedLocal;

                    const snapshot = await colRef.get();
                    
                    let firebaseData = [];
                    if (!snapshot.empty) {
                        firebaseData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }
                    
                    // MERGE STRATEGY
                    const combined = [...parsedLocal, ...firebaseData];
                    const uniqueMap = new Map();
                    combined.forEach(item => item.id && uniqueMap.set(item.id, item));
                    const mergedData = Array.from(uniqueMap.values());
                    
                    if (collectionName === 'activities') {
                        mergedData.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
                    }
                    
                    if (mergedData.length > 0) {
                        localStorage.setItem(`${this.localPrefix}${collectionName}`, JSON.stringify(mergedData));
                    }
                    
                    return mergedData;
                } catch (error) {
                    console.warn(`âš ï¸ Firebase read failed for ${collectionName}:`, error.message);
                    return parsedLocal;
                }
            },

            // Get single document
            async getDocument(collectionName, docId) {
                 if (!this.scope) return null;
                 // ... local storage fallback omitted for brevity but follows same pattern ...
                 try {
                    const colRef = this.getCollectionRef(collectionName);
                    if (!colRef) return null;
                    const doc = await colRef.doc(docId).get();
                    return doc.exists ? { id: doc.id, ...doc.data() } : null;
                } catch (error) {
                    return null;
                }
            },

            // Save/Update collection
            async saveCollection(collectionName, data) {
                if (!this.scope) return false;
                
                localStorage.setItem(`${this.localPrefix}${collectionName}`, JSON.stringify(data));
                
                if (!useFirebase) return true;
                
                try {
                    const colRef = this.getCollectionRef(collectionName);
                    if (!colRef) return false;

                    const batch = db.batch();
                    const snapshot = await colRef.get();
                    
                    // Note: Deleting everything and rewriting is simple but risky for concurrency. 
                    // ideally we'd use set/merge individually, but keeping your logic for now:
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    
                    data.forEach(item => {
                        const docRef = colRef.doc(item.id || colRef.doc().id);
                        batch.set(docRef, item);
                    });
                    
                    await batch.commit();
                    return true;
                } catch (error) {
                    console.warn(`âš ï¸ Firebase save failed for ${collectionName}:`, error.message);
                    return true;
                }
            },

            // Add document
            async addDocument(collectionName, data) {
                if (!this.scope) return null;

                // Local update
                if (!useFirebase) {
                    const existing = localStorage.getItem(`${this.localPrefix}${collectionName}`);
                    const items = existing ? JSON.parse(existing) : [];
                    const newItem = { ...data, id: data.id || Date.now().toString() };
                    items.push(newItem);
                    localStorage.setItem(`${this.localPrefix}${collectionName}`, JSON.stringify(items));
                    return newItem;
                }

                try {
                    const colRef = this.getCollectionRef(collectionName);
                    if (!colRef) return null;
                    const docRef = await colRef.add(data);
                    return { id: docRef.id, ...data };
                } catch (error) {
                    console.error("Error adding document:", error);
                    return null;
                }
            },

            // Update document
            async updateDocument(collectionName, docId, data) {
                if (!this.scope) return false;

                // Local update
                const existing = localStorage.getItem(`${this.localPrefix}${collectionName}`);
                if (existing) {
                    const items = JSON.parse(existing);
                    const index = items.findIndex(item => item.id === docId);
                    if (index !== -1) {
                        items[index] = { ...items[index], ...data };
                        localStorage.setItem(`${this.localPrefix}${collectionName}`, JSON.stringify(items));
                    }
                }
                
                if (!useFirebase) return true;

                try {
                    const colRef = this.getCollectionRef(collectionName);
                    if (!colRef) return false;
                    await colRef.doc(docId).update(data);
                    return true;
                } catch (error) {
                    console.error("Error updating document:", error);
                    return false;
                }
            },

            // Delete document
            async deleteDocument(collectionName, docId) {
                if (!this.scope) return false;

                // Local update
                const existing = localStorage.getItem(`${this.localPrefix}${collectionName}`);
                if (existing) {
                    const items = JSON.parse(existing);
                    const filtered = items.filter(item => item.id !== docId);
                    localStorage.setItem(`${this.localPrefix}${collectionName}`, JSON.stringify(filtered));
                }

                if (!useFirebase) return true;

                try {
                    const colRef = this.getCollectionRef(collectionName);
                    if (!colRef) return false;
                    await colRef.doc(docId).delete();
                    return true;
                } catch (error) {
                    console.error("Error deleting document:", error);
                    return false;
                }
            },
            
            // Get settings (Scoped)
            async getSettings(settingKey) {
                if (!this.scope) return null;
                const localValue = localStorage.getItem(`${this.localPrefix}${settingKey}`);
                
                if (!useFirebase) return localValue;
                
                try {
                    const colRef = this.getCollectionRef('settings'); // Subcollection for settings
                    const doc = await colRef.doc(settingKey).get();
                    if (doc.exists) {
                        const firebaseValue = doc.data().value;
                        localStorage.setItem(`${this.localPrefix}${settingKey}`, firebaseValue);
                        return firebaseValue;
                    }
                    return localValue;
                } catch (error) {
                    return localValue;
                }
            },

            // Save Setting (Scoped)
            async saveSetting(settingKey, value) {
                if (!this.scope) return false;
                localStorage.setItem(`${this.localPrefix}${settingKey}`, value);
                
                if (!useFirebase) return true;
                try {
                     const colRef = this.getCollectionRef('settings');
                     await colRef.doc(settingKey).set({ value });
                     return true;
                } catch (e) { return false; }
            },
            
            // User Management (Global)
            async getUserProfile(uid) {
                if (!useFirebase) return null;
                try {
                    const doc = await db.collection('users').doc(uid).get();
                    return doc.exists ? doc.data() : null;
                } catch(e) { console.error(e); return null; }
            },
            
            async createUserProfile(uid, data) {
                if (!useFirebase) return;
                await db.collection('users').doc(uid).set(data, { merge: true });
            }
        };



        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        // Helper function to parse date correctly without timezone issues
        function parseLocalDate(dateString) {
            if (!dateString) return null;
            const [year, month, day] = dateString.split('-');
            return new Date(year, month - 1, day);
        }

        // Helper function to get client level based on visits
        function getClientLevel(visits) {
            if (visits >= 40) {
                return {
                    name: 'Gold',
                    color: '#FFD700',
                    bgColor: '#FFD700',
                    icon: 'workspace_premium',
                    minVisits: 40
                };
            } else if (visits >= 25) {
                return {
                    name: 'Silver',
                    color: '#C0C0C0',
                    bgColor: '#C0C0C0',
                    icon: 'military_tech',
                    minVisits: 25
                };
            } else if (visits >= 10) {
                return {
                    name: 'Bronze',
                    color: '#CD7F32',
                    bgColor: '#CD7F32',
                    icon: 'shield',
                    minVisits: 10
                };
            }
            return null;
        }

        // Notification/Toast Component
        function Toast({ message, type, onClose }) {
            const bgColor = type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-green-500';
            const icon = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'check_circle';
            
            return (
                <div class={`fixed top-4 left-1/2 -translate-x-1/2 z-[100] flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl ${bgColor} text-white animate-[slideDown_0.3s_ease-out]`}>
                    <span class="material-symbols-outlined text-white">{icon}</span>
                    <span class="font-medium">{message}</span>
                    <button onClick={onClose} class="ml-2 hover:bg-white/20 rounded-full p-1 transition-colors">
                        <span class="material-symbols-outlined text-sm">close</span>
                    </button>
                </div>
            );
        }

        // Simple Router Implementation
        // ============================================
        // LOGIN COMPONENT
        // ============================================
        function Login({ onLogin, loading }) {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-[#1C1E21] px-6 text-center font-display">
                    <div className="mb-8 relative">
                        <div className="absolute inset-0 bg-[#FA383E] blur-[40px] opacity-20 rounded-full"></div>
                        <img src="./Images/hor-barber-logo.png" alt="HOR Barber" className="h-32 w-32 object-contain relative z-10" />
                    </div>
                    
                    <h1 className="text-3xl font-extrabold text-white mb-2">HOR Barber</h1>
                    <p className="text-slate-400 mb-12">Manage your barber shop efficiently</p>
                    
                    <button 
                        onClick={onLogin}
                        disabled={loading}
                        className="flex items-center justify-center gap-3 w-full max-w-xs bg-white text-[#1C1E21] font-bold py-4 px-6 rounded-xl shadow-lg hover:bg-gray-100 transition-all active:scale-[0.98] disabled:opacity-70 disabled:cursor-not-allowed"
                    >
                        {loading ? (
                            <span className="material-symbols-outlined animate-spin text-[#1C1E21]">progress_activity</span>
                        ) : (
                            <>
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="w-6 h-6" />
                                <span>Sign in with Google</span>
                            </>
                        )}
                    </button>
                    
                    <p className="text-xs text-slate-600 mt-8 mb-4">Team access only</p>
                </div>
            );
        }

        // ============================================
        // SETUP BUSINESS COMPONENT (New One-Time Flow)
        // ============================================
        function SetupBusiness({ onSetupComplete, user }) {
            const [businessName, setBusinessName] = useState('');
            const [creating, setCreating] = useState(false);

            const handleCreate = async () => {
                if (!businessName.trim()) return alert('Please enter a business name');
                setCreating(true);
                
                // Create a simple ID from name
                const barbershopId = businessName.toLowerCase().replace(/[^a-z0-9]/g, '-') + '-' + Math.floor(Math.random() * 1000);
                
                try {
                    // 1. Create User Profile linked to this barbershop
                    await FirebaseService.createUserProfile(user.uid, {
                        email: user.email,
                        displayName: user.displayName,
                        barbershopId: barbershopId,
                        role: 'owner',
                        joinedAt: new Date().toISOString()
                    });
                    
                    // 2. Initialize default Business Info in the NEW scope
                    FirebaseService.setScope(barbershopId);
                    
                    const defaultBusinessInfo = {
                        name: businessName,
                        email: user.email,
                        phone: '',
                        address: '',
                        owner: user.uid
                    };
                    
                    await FirebaseService.saveSetting('business_info', JSON.stringify(defaultBusinessInfo));
                    
                    onSetupComplete(barbershopId);
                } catch (error) {
                    console.error("Error setting up business", error);
                    alert("Error creating business. Please try again.");
                } finally {
                    setCreating(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-[#1C1E21] px-6 text-center font-display">
                    <div className="w-full max-w-md bg-[#2A2D31] p-8 rounded-2xl border border-white/5 shadow-xl">
                        <div className="mb-6">
                             <div className="w-16 h-16 bg-[#FA383E]/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span className="material-symbols-outlined text-[#FA383E] text-3xl">store</span>
                            </div>
                            <h2 className="text-2xl font-bold text-white">Create Your Business</h2>
                            <p className="text-slate-400 mt-2">Welcome {user.displayName}! Let's set up your new workspace.</p>
                        </div>
                        
                        <div className="space-y-4 text-left">
                            <div>
                                <label className="text-white text-sm font-medium mb-1 block">Barbershop Name</label>
                                <input 
                                    type="text" 
                                    value={businessName}
                                    onChange={(e) => setBusinessName(e.target.value)}
                                    placeholder="e.g. Downtown Cuts"
                                    className="w-full h-12 rounded-xl bg-[#1C1E21] border border-white/10 px-4 text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                                />
                            </div>
                            
                            <button 
                                onClick={handleCreate}
                                disabled={creating}
                                className="w-full bg-[#FA383E] text-white font-bold py-3.5 rounded-xl hover:bg-[#D42F34] transition-colors mt-2 flex items-center justify-center gap-2"
                            >
                                {creating ? 'Setting up...' : 'Start Managing'}
                                {!creating && <span className="material-symbols-outlined">arrow_forward</span>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // APP COMPONENT
        // ============================================
        function App() {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [loginLoading, setLoginLoading] = useState(false);
            const [barbershopId, setBarbershopId] = useState(null); // Current Tenant ID

            const [currentPage, setCurrentPage] = useState('dashboard');
            const [selectedClient, setSelectedClient] = useState(null);
            const [navigationData, setNavigationData] = useState(null);
            const [deleteModalClient, setDeleteModalClient] = useState(null);
            const [loading, setLoading] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            
            const [clients, setClients] = useState([]);
            const [activities, setActivities] = useState([]);

            // Handle Auth State & Redirect Result
            React.useEffect(() => {
                if (useFirebase && auth) {
                    auth.getRedirectResult().then((result) => {
                        if (result.user) {
                            console.log("Redirect login successful"); 
                        }
                    }).catch((error) => {
                        console.error("Redirect auth error:", error);
                        // Ignorar unauthorized-domain si estamos en localhost, ya que onAuthStateChanged lo manejarÃ¡
                        if (error.code !== 'auth/unauthorized-domain') {
                             showToast('Login error: ' + error.message, 'error');
                        }
                    });

                    const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                        // Evitar estado 'infinito' si authLoading ya terminÃ³
                        if(currentUser) {
                             setUser(currentUser);
                             try {
                                const userProfile = await FirebaseService.getUserProfile(currentUser.uid);
                                if (userProfile && userProfile.barbershopId) {
                                    setBarbershopId(userProfile.barbershopId);
                                    FirebaseService.setScope(userProfile.barbershopId);
                                    loadData();
                                } else {
                                    setBarbershopId(null); 
                                }
                            } catch (e) {
                                console.error("Error fetching user profile", e);
                            }
                        } else {
                            setUser(null);
                            setClients([]);
                            setActivities([]);
                            setBarbershopId(null);
                        }
                        setAuthLoading(false);
                    });
                    return () => unsubscribe();
                } else {
                    // Fallback locked out - must use Firebase
                    setAuthLoading(false);
                }
            }, []);

            const handleSetupComplete = (newId) => {
                setBarbershopId(newId);
                loadData();
            };

            const handleGoogleLogin = async () => {
                if (!useFirebase || !auth) {
                    showToast('Firebase authentication not available', 'warning');
                    return;
                }
                setLoginLoading(true);
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    // Volver a Popup que es mÃ¡s estable en desarrollo local
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    console.error('Login error:', error);
                    showToast('Login failed: ' + error.message, 'warning');
                } finally {
                    setLoginLoading(false);
                }
            };
            
            const handleDemoLogin = () => {
                const demoUser = {
                    uid: 'demo-user-123',
                    displayName: 'Demo Master',
                    email: 'demo@horbarber.com',
                    photoURL: './Images/hor-barber-logo.png'
                };
                setUser(demoUser);
                setBarbershopId('local-demo-shop');
                FirebaseService.setScope('local-demo-shop');
                // Ensure local storage has data for demo
                loadData();
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    showToast('Logged out successfully', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            };

            const showToast = (message, type = 'success') => {
                setToast({ show: true, message, type });
                setTimeout(() => setToast(prev => ({ ...prev, show: false })), 3000);
            };
            
            // Load data function
            async function loadData() {
                setLoading(true);
                try {
                    // Load clients
                    let clientsData = await FirebaseService.getCollection('clients');
                    if (!clientsData || clientsData.length === 0) {
                        // Use default data if no clients exist (Only on first run or empty DB)
                        // ... default data logic kept same ...
                         clientsData = [
                                {
                                    id: '1',
                                    name: 'Marcus Thompson',
                                    phone: '+1 555-0123',
                                    email: 'marcus.t@email.com',
                                    birthDate: '1988-03-15',
                                    visits: 45,
                                    lastVisit: '2026-01-10',
                                    preferredBarber: 'Juan',
                                    image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuDB_qYugZ2DiDNEkOuZFpJDWzmxUL5OpZZB9ZBb_E256nupm0rwAyE2PpW96NU-VaCuT4514rygZEKB60rDRdA8aGFDMNA8joUKL_gsnxMHIzwinmSyud18_i-GUkaO1ouIbHlmNlJnFz6UmmCn2M8XwyxwmW98SidPKLr0SPabaNeRz34QIwOTH9yjmEDplD35_rgUpUr6vG1I6ZIQz7m7XxzpamrRFHmQQjVHDCvoJ-rTWJAaw5dNp4O-TPj4Ref0dE0iU4tDgeY9'
                                },
                                {
                                    id: '2',
                                    name: 'Sarah Chen',
                                    phone: '+1 555-0124',
                                    email: 'sarah.c@email.com',
                                    birthDate: '1992-07-22',
                                    visits: 28,
                                    lastVisit: '2026-01-08',
                                    preferredBarber: 'Nico'
                                },
                                {
                                    id: '3',
                                    name: 'David Rodriguez',
                                    phone: '+1 555-0125',
                                    email: 'david.r@email.com',
                                    birthDate: '1985-11-30',
                                    visits: 12,
                                    lastVisit: '2026-01-05',
                                    preferredBarber: 'Pedro'
                                }
                            ];
                        await FirebaseService.saveCollection('clients', clientsData);
                    }
                    setClients(clientsData);
                    console.log('âœ… Loaded clients:', clientsData.length);
                    
                    // Load activities
                    const activitiesData = await FirebaseService.getCollection('activities');
                    setActivities(activitiesData || []);
                    console.log('âœ… Loaded activities:', (activitiesData || []).length);
                } catch (error) {
                    console.error('Error loading data:', error);
                } finally {
                    setLoading(false);
                }
            };
            
            // Note: UseEffects for saving data controlled by 'loading' state are still valid below

            // Save clients to Firebase/localStorage whenever they change
            React.useEffect(() => {
                if (!loading && !authLoading && user && clients.length > 0) {
                    const saveClients = async () => {
                        await FirebaseService.saveCollection('clients', clients);
                        console.log('ðŸ’¾ Saved clients:', clients.length);
                    };
                    saveClients();
                }
            }, [clients, loading, authLoading, user]);
            
            // Save activities to Firebase/localStorage whenever they change
            React.useEffect(() => {
                if (!loading && !authLoading && user) {
                    const saveActivities = async () => {
                        await FirebaseService.saveCollection('activities', activities);
                        console.log('ðŸ’¾ Saved activities:', activities.length);
                    };
                    saveActivities();
                }
            }, [activities, loading, authLoading, user]);
            
            const addClient = (newClient) => {
                const client = {
                    ...newClient,
                    id: Date.now().toString(),
                    createdAt: new Date().toISOString(),
                    visits: 0,
                    lastVisit: null
                };
                setClients(prev => [client, ...prev]);
                return client;
            };
            
            const updateClient = (updatedClient) => {
                setClients(prev => prev.map(c => 
                    c.id === updatedClient.id ? updatedClient : c
                ));
                // Update selectedClient if it's the same client
                if (selectedClient && selectedClient.id === updatedClient.id) {
                    setSelectedClient(updatedClient);
                }
                return updatedClient;
            };
            
            const deleteClient = (clientId) => {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    setDeleteModalClient(client);
                }
            };
            
            const confirmDeleteClient = () => {
                if (deleteModalClient) {
                    setClients(prev => prev.filter(c => c.id !== deleteModalClient.id));
                    // Keep activities for historical records - don't delete them
                    const deletedClient = deleteModalClient;
                    setDeleteModalClient(null);
                    navigate('client-deleted-success', deletedClient);
                }
            };
            
            const cancelDeleteClient = () => {
                setDeleteModalClient(null);
            };
            
            const addActivity = (activity) => {
                // Attach the user who performed the activity if available
                const newActivity = {
                    ...activity,
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    createdBy: user ? user.displayName : 'Unknown',
                    creatorEmail: user ? user.email : 'Unknown'
                };
                setActivities(prev => [newActivity, ...prev]);
                return newActivity;
            };

            const navigate = (page, data = null) => {
                setCurrentPage(page);
                setNavigationData(data);
                // Only set selectedClient if data looks like a client object
                if (data && data.id) {
                    setSelectedClient(data);
                }
            };

            // Authentication Loading Screen
            if (authLoading) {
                 return (
                    <div className="flex items-center justify-center min-h-screen bg-[#1C1E21]">
                        <img 
                            src="./Images/hor-barber-logo.png" 
                            className="h-24 w-24 object-contain mx-auto animate-pulse" 
                            alt="Loading App..."
                        />
                    </div>
                );
            }

            // Not Logged In -> Show Login Screen
            if (!user && useFirebase) {
                return <Login onLogin={handleGoogleLogin} loading={loginLoading} />;
            }
            
            // Logged In BUT No Business Set -> Show Setup Screen
            if (user && !barbershopId && useFirebase) {
                return <SetupBusiness user={user} onSetupComplete={handleSetupComplete} />;
            }

            return (
                <>
                    {/* Render App Content Only if User is Logged In */}
                    {loading ? (
                        <div className="flex items-center justify-center min-h-screen bg-[#1C1E21]">
                            <div className="text-center">
                                <img 
                                    src="Images/hor-barber-logo.png" 
                                    className="h-24 w-24 object-contain mx-auto mb-6 animate-[spin_3s_linear_infinite]" 
                                    alt="Loading..."
                                />
                                <p className="text-slate-400 text-sm">Loading your salon data...</p>
                            </div>
                        </div>
                    ) : (
                        /* Main App Layout */
                        <div className="bg-[#1C1E21] min-h-screen">
                            {currentPage === 'dashboard' && <Dashboard navigate={navigate} clients={clients} activities={activities} />}
                            {currentPage === 'client-profile' && <ClientProfile navigate={navigate} client={selectedClient} activities={activities} updateClient={updateClient} />}
                            {currentPage === 'register-client' && <RegisterClient navigate={navigate} addClient={addClient} showToast={showToast} />}
                            {currentPage === 'client-added-success' && <ClientAddedSuccess navigate={navigate} client={selectedClient} />}
                            {currentPage === 'edit-client' && <EditClient navigate={navigate} client={selectedClient} updateClient={updateClient} showToast={showToast} />}
                            {currentPage === 'client-updated-success' && <ClientUpdatedSuccess navigate={navigate} client={selectedClient} />}
                            {currentPage === 'client-deleted-success' && <ClientDeletedSuccess navigate={navigate} client={selectedClient} />}
                            {currentPage === 'record-service' && <RecordService navigate={navigate} client={selectedClient} clients={clients} setClients={setClients} addActivity={addActivity} showToast={showToast} />}
                            {currentPage === 'prize-redeemed' && <PrizeRedeemed navigate={navigate} client={selectedClient} />}
                            {currentPage === 'client-history' && <ClientHistory navigate={navigate} client={selectedClient} activities={activities} />}
                            {currentPage === 'settings' && <Settings navigate={navigate} user={user} handleLogout={handleLogout} />}
                            {currentPage === 'manage-barbers' && <ManageBarbers navigate={navigate} data={navigationData} showToast={showToast} />}
                            {currentPage === 'edit-barber' && <EditBarber navigate={navigate} data={navigationData} showToast={showToast} />}
                            {currentPage === 'business-info' && <BusinessInfo navigate={navigate} data={navigationData} showToast={showToast} />}
                            {currentPage === 'service-prices' && <ServicePrices navigate={navigate} data={navigationData} showToast={showToast} />}
                            {currentPage === 'barber-schedules' && <BarberSchedules navigate={navigate} data={navigationData} showToast={showToast} />}
                            {currentPage === 'reward-rules' && <RewardRules navigate={navigate} />}
                            {currentPage === 'notifications' && <Notifications navigate={navigate} clients={clients} />}
                            {currentPage === 'voucher-history' && <VoucherHistory navigate={navigate} />}
                            {currentPage === 'barber-detail' && <BarberDetail navigate={navigate} barber={selectedClient} />}
                            {currentPage === 'edit-barber-schedule' && <EditBarberSchedule navigate={navigate} barber={selectedClient} showToast={showToast} />}
                            {currentPage === 'clients-list' && <ClientsList navigate={navigate} clients={clients} deleteClient={deleteClient} showToast={showToast} />}
                            {currentPage === 'analytics' && <Analytics navigate={navigate} clients={clients} activities={activities} />}
                            {currentPage === 'recent-activity' && <RecentActivity navigate={navigate} activities={activities} />}
                            
                            {/* Toast Notification */}
                            {toast.show && (
                                <Toast 
                                    message={toast.message} 
                                    type={toast.type} 
                                    onClose={() => setToast({ ...toast, show: false })} 
                                />
                            )}
        
                            {/* Delete Confirmation Modal */}
                            {deleteModalClient && (
                                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                                    <div className="bg-[#2A2D31] rounded-2xl p-6 max-w-sm w-full border border-white/10 shadow-2xl">
                                        <div className="flex items-center justify-center w-16 h-16 rounded-full bg-red-500/20 border-2 border-red-500/50 mx-auto mb-4">
                                            <span className="material-symbols-outlined text-red-500 text-3xl">warning</span>
                                        </div>
                                        <h3 className="text-white text-xl font-bold text-center mb-2">Delete Client?</h3>
                                        <p className="text-slate-400 text-center mb-2">Are you sure you want to delete</p>
                                        <p className="text-white text-center font-bold mb-4">{deleteModalClient.name}?</p>
                                        <p className="text-slate-500 text-sm text-center mb-6">This will remove the client from your list. Visit history will be preserved for records.</p>
                                        <div className="flex gap-3">
                                            <button 
                                                onClick={cancelDeleteClient}
                                                className="flex-1 px-4 py-3 bg-[#35383D] border border-white/10 rounded-xl text-white font-bold hover:bg-[#3A3D42] transition-colors"
                                            >
                                                Cancel
                                            </button>
                                            <button 
                                                onClick={confirmDeleteClient}
                                                className="flex-1 px-4 py-3 bg-red-500 rounded-xl text-white font-bold hover:bg-red-600 transition-colors"
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </>
            );
        }

        // Dashboard Component
        function Dashboard({ navigate, clients, activities }) {
            // Get recent activities (last 5)
            const recentActivities = activities.slice(0, 5);
            
            // Dates setup
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const yesterdayDate = new Date(now);
            yesterdayDate.setDate(now.getDate() - 1);
            const yesterday = yesterdayDate.toISOString().split('T')[0];
            
            // 1. Visits Logic
            const todayActivities = activities.filter(activity => {
                const activityDate = new Date(activity.timestamp).toISOString().split('T')[0];
                return activityDate === today;
            });
            const todayVisits = todayActivities.length;

            const yesterdayActivities = activities.filter(activity => {
                const activityDate = new Date(activity.timestamp).toISOString().split('T')[0];
                return activityDate === yesterday;
            });
            const yesterdayVisits = yesterdayActivities.length;

            // Calculate Visits change
            let visitsChangeLabel = "0%";
            let visitsTrendClass = "text-slate-400 bg-slate-400/10"; // neutral

            if (yesterdayVisits === 0) {
                if (todayVisits > 0) {
                    visitsChangeLabel = "New Activity";
                    visitsTrendClass = "text-green-500 bg-green-500/10";
                }
            } else {
                const change = ((todayVisits - yesterdayVisits) / yesterdayVisits) * 100;
                visitsChangeLabel = (change > 0 ? "+" : "") + Math.round(change) + "%";
                visitsTrendClass = change >= 0 ? "text-green-500 bg-green-500/10" : "text-red-500 bg-red-500/10";
            }
            
            // 2. New Clients Logic (Registered Today vs Yesterday)
            const getClientDate = (client) => {
                if (client.createdAt) return new Date(client.createdAt);
                if (client.id && !isNaN(client.id) && client.id.length > 10) return new Date(parseInt(client.id));
                return null;
            };

            const newClientsToday = clients.filter(client => {
                const date = getClientDate(client);
                return date && date.toISOString().split('T')[0] === today;
            }).length;

            const newClientsYesterday = clients.filter(client => {
                const date = getClientDate(client);
                return date && date.toISOString().split('T')[0] === yesterday;
            }).length;

            // Calculate Clients change
            let clientsChangeLabel = "0%";
            let clientsTrendClass = "text-slate-400 bg-slate-400/10"; // neutral

            if (newClientsYesterday === 0) {
                if (newClientsToday > 0) {
                    clientsChangeLabel = "New Growth";
                    clientsTrendClass = "text-green-500 bg-green-500/10";
                }
            } else {
                const change = ((newClientsToday - newClientsYesterday) / newClientsYesterday) * 100;
                clientsChangeLabel = (change > 0 ? "+" : "") + Math.round(change) + "%";
                clientsTrendClass = change >= 0 ? "text-green-500 bg-green-500/10" : "text-red-500 bg-red-500/10";
            }
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col overflow-x-hidden pb-20 bg-[#1C1E21]">
                    {/* Header */}
                    <div class="sticky top-0 z-50 flex items-center justify-between px-4 py-4 bg-[#1C1E21]/95 backdrop-blur-md border-b border-white/5">
                        <div class="flex items-center gap-3">
                            <img src="./Images/hor-barber-logo.png" alt="HOR. Barber" className="h-12 scale-125" />
                        </div>
                        <button class="relative flex items-center justify-center w-10 h-10 rounded-full bg-[#2A2D31] hover:bg-[#35383D] transition-colors">
                            <span class="material-symbols-outlined text-[#FA383E]" style={{fontSize: '24px'}}>notifications</span>
                            <span class="absolute top-2 right-2 w-2 h-2 rounded-full bg-[#FA383E] ring-2 ring-[#1C1E21]"></span>
                        </button>
                    </div>
                    
                    {/* Daily Overview */}
                    <div class="px-4 py-6">
                        <h3 class="text-lg font-bold text-white mb-4">Daily Overview</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex flex-col p-5 bg-[#2A2D31] rounded-xl shadow-sm border border-white/5">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-2 rounded-lg bg-[#FA383E]/10">
                                        <span class="material-symbols-outlined text-[#FA383E]">content_cut</span>
                                    </div>
                                    <span class={`text-xs font-semibold px-2 py-0.5 rounded-full ${visitsTrendClass}`}>{visitsChangeLabel}</span>
                                </div>
                                <p class="text-sm font-medium text-slate-400">Today's Visits</p>
                                <p class="text-3xl font-extrabold text-white mt-1">{todayVisits}</p>
                            </div>
                            
                            <div class="flex flex-col p-5 bg-[#2A2D31] rounded-xl shadow-sm border border-white/5">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-2 rounded-lg bg-[#FA383E]/10">
                                        <span class="material-symbols-outlined text-[#FA383E]">person_add</span>
                                    </div>
                                    <span class={`text-xs font-semibold px-2 py-0.5 rounded-full ${clientsTrendClass}`}>{clientsChangeLabel}</span>
                                </div>
                                <p class="text-sm font-medium text-slate-400">New Clients</p>
                                <p class="text-3xl font-extrabold text-white mt-1">{newClientsToday}</p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Recent Activity */}
                    <div class="flex-1 px-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-white">Recent Activity</h3>
                            <a onClick={() => navigate('recent-activity')} class="text-sm font-medium text-[#FA383E] hover:text-[#F35369] cursor-pointer">View All</a>
                        </div>
                        
                        <div class="flex flex-col gap-3">
                            {recentActivities.length > 0 ? (
                                recentActivities.map(activity => {
                                    // Try to find client, but don't fail if deleted
                                    const client = clients.find(c => c.id === activity.clientId);
                                    
                                    // Fallback values if client is deleted
                                    const clientName = client ? client.name : (activity.clientName || 'Unknown Client');
                                    const visits = client ? (client.visits || 0) : 0;
                                    const level = getClientLevel(visits);
                                    
                                    const activityTime = new Date(activity.timestamp);
                                    const timeStr = activityTime.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                                    
                                    return (
                                        <div 
                                            key={activity.id} 
                                            onClick={() => client && navigate('client-profile', client)} 
                                            class={`flex items-center gap-4 p-3 bg-[#2A2D31] rounded-xl border border-white/5 hover:border-[#FA383E]/50 transition-colors ${client ? 'cursor-pointer' : 'cursor-default opacity-80'}`}
                                        >
                                            <div class="relative shrink-0">
                                                {client && client.image ? (
                                                    <div class="h-12 w-12 rounded-full bg-cover bg-center" style={{backgroundImage: `url("${client.image}")`}}></div>
                                                ) : (
                                                    <div class="h-12 w-12 rounded-full bg-[#2A2D31] border-2 border-[#FA383E] flex items-center justify-center text-[#FA383E] font-bold text-lg">
                                                        {clientName.charAt(0).toUpperCase()}
                                                    </div>
                                                )}
                                                {/* Only show badge if client still exists */}
                                                {client && level && (
                                                    <div class="absolute -bottom-1 -right-1 rounded-full p-0.5 border-2 border-[#1C1E21]" style={{backgroundColor: level.bgColor}} title={`${level.name} Member`}>
                                                        <span class="material-symbols-outlined text-white" style={{fontSize: '14px'}}>{level.icon}</span>
                                                    </div>
                                                )}
                                            </div>
                                            <div class="flex flex-col flex-1 min-w-0">
                                                <div class="flex justify-between items-start">
                                                    <p class="text-base font-bold text-white truncate">{clientName}</p>
                                                    <span class="text-xs font-medium text-slate-500">{timeStr}</span>
                                                </div>
                                                <p class="text-sm text-slate-400 truncate">
                                                    {activity.service} - {activity.barber} {!client && '(Deleted)'}
                                                </p>
                                            </div>
                                        </div>
                                    );
                                })
                            ) : (
                                <div class="text-center py-8">
                                    <span class="material-symbols-outlined text-slate-600 text-4xl mb-2 block">content_cut</span>
                                    <p class="text-slate-500 text-sm">No recent activity</p>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Bottom Navigation */}
                    <div class="fixed bottom-0 left-0 right-0 z-50 bg-[#1C1E21] border-t border-white/5 pb-safe">
                        <div class="flex items-center justify-around h-16">
                            <button onClick={() => navigate('dashboard')} class="flex flex-col items-center justify-center gap-1 p-2 text-[#FA383E]">
                                <span class="material-symbols-outlined filled">dashboard</span>
                                <span class="text-[10px] font-medium">Home</span>
                            </button>
                            <button onClick={() => navigate('clients-list')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">people</span>
                                <span class="text-[10px] font-medium">Clients</span>
                            </button>
                            <button onClick={() => navigate('analytics')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">bar_chart</span>
                                <span class="text-[10px] font-medium">Analytics</span>
                            </button>
                            <button onClick={() => navigate('settings')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">settings</span>
                                <span class="text-[10px] font-medium">Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Client Profile Component  
        function ClientProfile({ navigate, client, activities, updateClient }) {
            const [isEditingNotes, setIsEditingNotes] = React.useState(false);
            const [notes, setNotes] = React.useState(client?.notes || '');
            
            // Sync notes when client changes
            React.useEffect(() => {
                setNotes(client?.notes || '');
            }, [client?.notes, client?.id]);
            
            const handleSaveNotes = () => {
                const updatedClient = {
                    ...client,
                    notes: notes
                };
                updateClient(updatedClient);
                setIsEditingNotes(false);
            };
            
            if (!client) {
                return (
                    <div class="bg-[#1C1E21] text-white font-display antialiased min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <p class="text-slate-400 mb-4">No client selected</p>
                            <button onClick={() => navigate('dashboard')} class="px-6 py-3 bg-[#FA383E] rounded-xl font-bold">Back to Dashboard</button>
                        </div>
                    </div>
                );
            }
            
            return (
                <div class="bg-[#1C1E21] text-white font-display antialiased min-h-screen flex flex-col">
                    {/* Header */}
                    <div class="sticky top-0 z-50 flex items-center bg-[#1C1E21] p-4 pb-2 justify-between border-b border-white/5">
                        <button onClick={() => navigate('dashboard')} class="text-white flex size-12 shrink-0 items-center justify-center rounded-full hover:bg-white/10 transition-colors">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h2 class="text-white text-xl font-bold leading-tight tracking-tight flex-1 text-center">Client Profile</h2>
                        <div class="flex w-12 items-center justify-end">
                            <button onClick={() => navigate('edit-client', client)} class="flex size-12 cursor-pointer items-center justify-center overflow-hidden rounded-full bg-transparent text-white hover:bg-white/10 transition-colors">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto pb-24">
                        {/* Profile Header */}
                        <div class="flex flex-col items-center pt-8 pb-6 px-4">
                            <div class="relative mb-4">
                                {client.image ? (
                                    <div class="bg-center bg-no-repeat bg-cover rounded-full h-28 w-28 border-4 border-[#FA383E] shadow-lg shadow-[#FA383E]/20" style={{backgroundImage: `url("${client.image}")`}}></div>
                                ) : (
                                    <div class="rounded-full h-28 w-28 border-4 border-[#FA383E] shadow-lg shadow-[#FA383E]/20 bg-[#2A2D31] flex items-center justify-center text-4xl font-bold text-[#FA383E]">
                                        {client.name.charAt(0)}
                                    </div>
                                )}
                                {(() => {
                                    const level = getClientLevel(client.visits || 0);
                                    return level ? (
                                        <div class="absolute bottom-0 right-0 text-white rounded-full p-1.5 border-2 border-[#1C1E21]" style={{backgroundColor: level.bgColor}} title={`${level.name} Member`}>
                                            <span class="material-symbols-outlined text-[14px] block">{level.icon}</span>
                                        </div>
                                    ) : (
                                        <div class="absolute bottom-0 right-0 bg-[#FA383E] text-white rounded-full p-1.5 border-2 border-[#1C1E21]">
                                            <span class="material-symbols-outlined text-[14px] block">verified</span>
                                        </div>
                                    );
                                })()}
                            </div>
                            <h1 class="text-white text-2xl font-bold leading-tight tracking-tight text-center mb-3">{client.name}</h1>
                            <div class="flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 backdrop-blur-sm border border-white/10 mb-2">
                                <span class="material-symbols-outlined text-sm text-gray-400">phone</span>
                                <span class="text-sm font-medium text-gray-300">{client.phone}</span>
                            </div>
                            {client.birthDate && (
                                <div class="flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 backdrop-blur-sm border border-white/10 mb-2">
                                    <span class="material-symbols-outlined text-sm text-gray-400">cake</span>
                                    <span class="text-sm font-medium text-gray-300">
                                        {parseLocalDate(client.birthDate).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'})}
                                    </span>
                                </div>
                            )}
                            {client.preferredBarber && (
                                <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-[#FA383E]/20 border border-[#FA383E]/30 mt-2">
                                    <span class="material-symbols-outlined text-sm text-[#FA383E]">person</span>
                                    <span class="text-sm font-medium text-[#FA383E]">Barber: {client.preferredBarber}</span>
                                </div>
                            )}
                            <p class="text-gray-400 text-sm font-medium mt-3">Member since 2024</p>
                        </div>
                        
                        {/* Loyalty Card */}
                        <div class="px-4 mb-6">
                            <div class="relative w-full rounded-2xl overflow-hidden shadow-2xl bg-gradient-to-br from-[#2A2D31] to-[#1C1E21] border border-white/10">
                                <div class="relative z-10 p-6 flex flex-col gap-6">
                                    {(() => {
                                        const level = getClientLevel(client.visits || 0);
                                        return (
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <p class="text-[#FA383E] text-xs font-bold uppercase tracking-widest mb-1">Loyalty Program</p>
                                                    <h3 class="text-white text-2xl font-bold tracking-tight">
                                                        {level ? `${level.name} Member` : 'Member'}
                                                    </h3>
                                                    {level && (
                                                        <p class="text-slate-400 text-xs mt-1">{client.visits} cuts completed</p>
                                                    )}
                                                </div>
                                                <div class="p-2.5 rounded-xl backdrop-blur-sm border" style={{
                                                    backgroundColor: level ? `${level.bgColor}20` : '#FA383E20',
                                                    borderColor: level ? `${level.bgColor}30` : '#FA383E30'
                                                }}>
                                                    <span class="material-symbols-outlined block text-[24px]" style={{
                                                        color: level ? level.color : '#FA383E'
                                                    }}>
                                                        {level ? level.icon : 'diamond'}
                                                    </span>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                    
                                    {/* Progress Grid */}
                                    {(() => {
                                        const totalVisits = client.visits || 0;
                                        const currentCycleVisits = totalVisits % 10; // Progreso en el ciclo actual
                                        const completedCycles = Math.floor(totalVisits / 10); // CuÃ¡ntos ciclos completos
                                        
                                        return (
                                            <>
                                                <div class="grid grid-cols-5 gap-3">
                                                    {[...Array(currentCycleVisits)].map((_, i) => (
                                                        <div key={i} class="flex flex-col items-center">
                                                            <div class="flex items-center justify-center w-full aspect-square rounded-full bg-[#FA383E] text-white shadow-lg">
                                                                <span class="material-symbols-outlined text-[18px]">content_cut</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {[...Array(10 - currentCycleVisits)].map((_, i) => (
                                                        <div key={i} class="flex flex-col items-center">
                                                            <div class="flex items-center justify-center w-full aspect-square rounded-full bg-white/5 border-2 border-dashed border-white/20 text-white/30">
                                                                <span class="material-symbols-outlined text-[18px]">content_cut</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                                
                                                <div class="flex items-center justify-between border-t border-white/10 pt-4">
                                                    <div>
                                                        <p class="text-gray-300 text-sm font-medium">{currentCycleVisits} of 10 cuts completed</p>
                                                        {completedCycles > 0 && (
                                                            <p class="text-slate-500 text-xs mt-1">{completedCycles} reward{completedCycles > 1 ? 's' : ''} earned</p>
                                                        )}
                                                    </div>
                                                    <p class="text-[#FA383E] text-sm font-bold">{10 - currentCycleVisits} to go!</p>
                                                </div>
                                            </>
                                        );
                                    })()}
                                </div>
                            </div>
                        </div>
                        
                        {/* Stats Cards */}
                        <div class="px-4 mb-6 grid grid-cols-2 gap-3">
                            <div class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                                <p class="text-slate-400 text-sm mb-1">Total Visits</p>
                                <p class="text-white text-2xl font-bold">{client.visits || 0}</p>
                            </div>
                            <div class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                                <p class="text-slate-400 text-sm mb-1">Birthday</p>
                                <p class="text-[#FA383E] text-lg font-bold">
                                    {client.birthDate ? parseLocalDate(client.birthDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : 'N/A'}
                                </p>
                            </div>
                        </div>
                        
                        {/* Add New Visit Button */}
                        <div class="px-4 mb-8">
                            <button onClick={() => navigate('record-service', client)} class="relative w-full overflow-hidden rounded-xl h-14 bg-gradient-to-r from-[#F35369] to-[#FA383E] text-white shadow-lg hover:shadow-xl transition-all active:scale-[0.98]">
                                <div class="relative z-10 flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined font-bold">add_circle</span>
                                    <span class="text-base font-bold tracking-wide">Add New Visit</span>
                                </div>
                            </button>
                        </div>
                        
                        {/* Client Notes */}
                        <div class="px-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white text-xl font-bold flex items-center gap-2">
                                    <span class="material-symbols-outlined">notes</span>
                                    Notes
                                </h3>
                                {!isEditingNotes && (
                                    <button 
                                        onClick={() => setIsEditingNotes(true)} 
                                        class="text-[#FA383E] text-sm font-semibold hover:text-[#F35369] flex items-center gap-1"
                                    >
                                        <span class="material-symbols-outlined text-sm">edit</span>
                                        Edit
                                    </button>
                                )}
                            </div>
                            
                            {isEditingNotes ? (
                                <div class="flex flex-col gap-3">
                                    <textarea 
                                        class="flex w-full min-h-32 rounded-xl border-none bg-[#2A2D31] p-4 text-base font-normal text-white placeholder:text-gray-500 focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all resize-vertical"
                                        value={notes}
                                        onChange={(e) => setNotes(e.target.value)}
                                        placeholder="Add notes about this client (preferences, allergies, special requests, etc.)"
                                    />
                                    <div class="flex gap-2">
                                        <button 
                                            onClick={handleSaveNotes}
                                            class="flex-1 px-4 py-3 bg-[#FA383E] rounded-xl text-white font-bold hover:bg-[#F35369] transition-colors"
                                        >
                                            Save
                                        </button>
                                        <button 
                                            onClick={() => {
                                                setNotes(client.notes || '');
                                                setIsEditingNotes(false);
                                            }}
                                            class="flex-1 px-4 py-3 bg-[#2A2D31] border border-white/10 rounded-xl text-white font-bold hover:bg-[#35383D] transition-colors"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <div class="bg-[#2A2D31] p-4 rounded-2xl border border-white/5 min-h-24">
                                    {client.notes ? (
                                        <p class="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">{client.notes}</p>
                                    ) : (
                                        <p class="text-slate-500 text-sm italic">No notes added yet. Click Edit to add notes.</p>
                                    )}
                                </div>
                            )}
                        </div>
                        
                        {/* Service History */}
                        <div class="px-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white text-xl font-bold">Service History</h3>
                                <button onClick={() => navigate('client-history', client)} class="text-[#FA383E] text-sm font-semibold hover:text-[#F35369]">View All</button>
                            </div>
                            
                            <div class="flex flex-col gap-3">
                                {(() => {
                                    const clientActivities = activities.filter(a => a.clientId === client.id).slice(0, 3);
                                    if (clientActivities.length === 0) {
                                        return (
                                            <div class="text-center py-8">
                                                <span class="material-symbols-outlined text-slate-600 text-5xl mb-3 block">content_cut</span>
                                                <p class="text-slate-500">No service history yet</p>
                                            </div>
                                        );
                                    }
                                    return clientActivities.map(activity => {
                                        const activityDate = new Date(activity.timestamp);
                                        return (
                                            <div key={activity.id} class="bg-[#2A2D31] p-4 rounded-2xl border border-white/5 flex items-center justify-between">
                                                <div class="flex gap-4 items-center">
                                                    <div class="flex flex-col items-center justify-center w-12 rounded-lg bg-white/5 py-2">
                                                        <span class="text-[10px] font-bold uppercase text-gray-500">
                                                            {activityDate.toLocaleDateString('en-US', {month: 'short'})}
                                                        </span>
                                                        <span class="text-xl font-bold text-white">
                                                            {activityDate.getDate()}
                                                        </span>
                                                    </div>
                                                    <div>
                                                        <p class="text-white font-bold text-base leading-tight">{activity.service}</p>
                                                        <p class="text-gray-400 text-sm mt-1 flex items-center gap-1">
                                                            <span class="material-symbols-outlined text-[14px]">person</span> 
                                                            Barber: {activity.barber}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    });
                                })()}
                            </div>
                        </div>
                        
                        <div class="h-6"></div>
                    </div>
                </div>
            );
        }

        // Client History Component
        function ClientHistory({ navigate, client, activities }) {
            if (!client) {
                return (
                    <div class="bg-[#1C1E21] text-white font-display antialiased min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <p class="text-slate-400 mb-4">No client selected</p>
                            <button onClick={() => navigate('dashboard')} class="px-6 py-3 bg-[#FA383E] rounded-xl font-bold">Back to Dashboard</button>
                        </div>
                    </div>
                );
            }
            
            const clientActivities = activities.filter(a => a.clientId === client.id);
            
            return (
                <div class="bg-[#1C1E21] text-white font-display antialiased min-h-screen flex flex-col">
                    {/* Header */}
                    <div class="sticky top-0 z-50 flex items-center bg-[#1C1E21] p-4 pb-2 justify-between border-b border-white/5">
                        <button onClick={() => navigate('client-profile', client)} class="text-white flex size-12 shrink-0 items-center justify-center rounded-full hover:bg-white/10 transition-colors">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h2 class="text-white text-xl font-bold leading-tight tracking-tight flex-1 text-center">Service History</h2>
                        <div class="w-12"></div>
                    </div>
                    
                    {/* Client Info Header */}
                    <div class="px-4 py-6 border-b border-white/5">
                        <div class="flex items-center gap-4">
                            <div class="relative shrink-0">
                                {client.image ? (
                                    <div class="h-16 w-16 rounded-full bg-cover bg-center border-2 border-[#FA383E]" style={{backgroundImage: `url("${client.image}")`}}></div>
                                ) : (
                                    <div class="h-16 w-16 rounded-full bg-[#2A2D31] border-2 border-[#FA383E] flex items-center justify-center text-2xl font-bold text-[#FA383E]">
                                        {client.name.charAt(0)}
                                    </div>
                                )}
                            </div>
                            <div class="flex-1">
                                <h3 class="text-white text-xl font-bold">{client.name}</h3>
                                <p class="text-slate-400 text-sm mt-1">{client.visits} total visits</p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Activities List */}
                    <div class="flex-1 p-4 pb-24">
                        {clientActivities.length === 0 ? (
                            <div class="text-center py-12">
                                <span class="material-symbols-outlined text-slate-600 text-5xl mb-3 block">content_cut</span>
                                <p class="text-slate-500 text-lg">No service history yet</p>
                                <p class="text-slate-600 text-sm mt-2">Book the first service to see history</p>
                            </div>
                        ) : (
                            <div class="space-y-3">
                                {clientActivities.map((activity, index) => {
                                    const activityDate = new Date(activity.timestamp);
                                    const isToday = activityDate.toDateString() === new Date().toDateString();
                                    
                                    return (
                                        <div key={activity.id} class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                                            <div class="flex items-start justify-between mb-3">
                                                <div class="flex items-center gap-3">
                                                    <div class="bg-[#FA383E]/20 p-2 rounded-lg">
                                                        <span class="material-symbols-outlined text-[#FA383E]">content_cut</span>
                                                    </div>
                                                    <div>
                                                        <h4 class="text-white font-bold text-base">{activity.service}</h4>
                                                        <p class="text-slate-400 text-sm mt-0.5">by {activity.barber}</p>
                                                    </div>
                                                </div>
                                                {isToday && (
                                                    <span class="text-xs font-semibold text-green-500 bg-green-500/10 px-2 py-1 rounded-full">Today</span>
                                                )}
                                            </div>
                                            
                                            <div class="flex items-center gap-4 text-sm text-slate-400 pt-3 border-t border-white/5">
                                                <div class="flex items-center gap-1">
                                                    <span class="material-symbols-outlined text-sm">calendar_today</span>
                                                    <span>{activityDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}</span>
                                                </div>
                                                <div class="flex items-center gap-1">
                                                    <span class="material-symbols-outlined text-sm">schedule</span>
                                                    <span>{activityDate.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</span>
                                                </div>
                                            </div>
                                            
                                            {activity.notes && (
                                                <div class="mt-3 pt-3 border-t border-white/5">
                                                    <p class="text-slate-400 text-sm italic">"{activity.notes}"</p>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Register Client Component
        function RegisterClient({ navigate, addClient, showToast }) {
            const [formData, setFormData] = React.useState({
                name: '',
                phone: '',
                email: '',
                birthDate: '',
                preferredBarber: '',
                referral: '',
                notes: ''
            });

            const handleChange = (e) => {
                setFormData({
                    ...formData,
                    [e.target.name]: e.target.value
                });
            };

            const handleSubmit = () => {
                // Validation
                if (!formData.name.trim()) {
                    showToast ? showToast('âš ï¸ Please enter client name', 'warning') : alert('Please enter client name');
                    return;
                }
                if (!formData.phone.trim()) {
                    showToast ? showToast('âš ï¸ Please enter phone number', 'warning') : alert('Please enter phone number');
                    return;
                }
                if (!formData.email.trim()) {
                    showToast ? showToast('âš ï¸ Please enter email', 'warning') : alert('Please enter email');
                    return;
                }
                if (!formData.birthDate) {
                    showToast ? showToast('âš ï¸ Please select birth date', 'warning') : alert('Please select birth date');
                    return;
                }
                if (!formData.preferredBarber) {
                    showToast ? showToast('âš ï¸ Please select preferred barber', 'warning') : alert('Please select preferred barber');
                    return;
                }
                if (!formData.referral) {
                    showToast ? showToast('âš ï¸ Please select referral source', 'warning') : alert('Please select referral source');
                    return;
                }

                // Add client
                const newClient = addClient(formData);
                navigate('client-added-success', newClient);
            };

            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21] overflow-x-hidden font-display">
                    {/* Header */}
                    <div class="sticky top-0 z-10 flex items-center justify-between bg-[#1C1E21] p-4 pb-2 border-b border-white/5">
                        <button onClick={() => navigate('dashboard')} class="flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-white/10 transition-colors">
                            <span class="material-symbols-outlined text-white" style={{fontSize: '24px'}}>arrow_back</span>
                        </button>
                        <h2 class="text-white text-xl font-bold leading-tight tracking-tight flex-1 text-center pr-10">Register Client</h2>
                    </div>
                    
                    {/* Form Content */}
                    <div class="flex-1 flex flex-col px-6 pt-8 pb-32 gap-6">
                        
                        {/* Full Name */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="name">Full Name *</label>
                            <input 
                                className="flex w-full h-14 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-normal text-white placeholder:text-gray-500 focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all" 
                                id="name"
                                name="name"
                                value={formData.name}
                                onChange={handleChange}
                                placeholder="e.g., John Doe" 
                                type="text"
                            />
                        </div>
                        
                        {/* Phone Number */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="phone">Phone Number *</label>
                            <input 
                                className="flex w-full h-14 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-normal text-white placeholder:text-gray-500 focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all" 
                                id="phone"
                                name="phone"
                                value={formData.phone}
                                onChange={handleChange}
                                placeholder="e.g., +1 (555) 123-4567" 
                                type="tel"
                            />
                        </div>
                        
                        {/* Email */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="email">Email *</label>
                            <input 
                                className="flex w-full h-14 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-normal text-white placeholder:text-gray-500 focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all" 
                                id="email"
                                name="email"
                                value={formData.email}
                                onChange={handleChange}
                                placeholder="e.g., john@email.com" 
                                type="email"
                            />
                        </div>
                        
                        {/* Birth Date */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="birthDate">Birth Date *</label>
                            <input 
                                className="flex w-full h-14 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-normal text-white placeholder:text-gray-500 focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all" 
                                id="birthDate"
                                name="birthDate"
                                value={formData.birthDate}
                                onChange={handleChange}
                                type="date"
                            />
                        </div>
                        
                        {/* Preferred Barber */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="preferredBarber">Preferred Barber *</label>
                            <select 
                                className="w-full h-14 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-normal text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all" 
                                id="preferredBarber"
                                name="preferredBarber"
                                value={formData.preferredBarber}
                                onChange={handleChange}
                            >
                                <option value="">Select a preference</option>
                                <option value="Juan">Juan</option>
                                <option value="Nico">Nico</option>
                                <option value="Pedro">Pedro</option>
                            </select>
                        </div>
                        
                        {/* Referral Source */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="referral">How did you hear about us? *</label>
                            <select 
                                className="w-full h-14 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-normal text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all" 
                                id="referral"
                                name="referral"
                                value={formData.referral}
                                onChange={handleChange}
                            >
                                <option value="">Select an option</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Google Search">Google Search</option>
                                <option value="Friend Recommendation">Friend Recommendation</option>
                                <option value="Walk-in">Walk-in</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        {/* Notes */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="notes">Notes</label>
                            <textarea 
                                className="flex w-full min-h-32 rounded-xl border-none bg-[#2A2D31] p-4 text-base font-normal text-white placeholder:text-gray-500 focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all resize-vertical" 
                                id="notes"
                                name="notes"
                                value={formData.notes}
                                onChange={handleChange}
                                placeholder="Add notes about this client (preferences, allergies, special requests, etc.)"
                            />
                        </div>
                    </div>
                    
                    {/* Submit Button */}
                    <div class="fixed bottom-0 left-0 right-0 z-20 bg-[#1C1E21] p-6 border-t border-white/5 pb-8">
                        <button onClick={handleSubmit} class="flex w-full items-center justify-center rounded-xl bg-[#FA383E] h-14 px-4 shadow-lg shadow-[#FA383E]/20 active:scale-[0.98] transition-transform">
                            <span class="text-white text-base font-bold leading-normal tracking-wide">Create Profile</span>
                        </button>
                    </div>
                </div>
            );
        }

        // Edit Client Component
        function EditClient({ navigate, client, updateClient, showToast }) {
            const [formData, setFormData] = React.useState({
                name: client?.name || '',
                phone: client?.phone || '',
                email: client?.email || '',
                birthDate: client?.birthDate || '',
                preferredBarber: client?.preferredBarber || '',
                notes: client?.notes || '',
            });

            const handleChange = (e) => {
                setFormData({
                    ...formData,
                    [e.target.name]: e.target.value
                });
            };

            const handleSubmit = () => {
                // Validation
                if (!formData.name.trim()) {
                    showToast ? showToast('âš ï¸ Please enter client name', 'warning') : alert('Please enter client name');
                    return;
                }
                if (!formData.phone.trim()) {
                    showToast ? showToast('âš ï¸ Please enter phone number', 'warning') : alert('Please enter phone number');
                    return;
                }
                if (!formData.email.trim()) {
                    showToast ? showToast('âš ï¸ Please enter email', 'warning') : alert('Please enter email');
                    return;
                }
                if (!formData.birthDate) {
                    showToast ? showToast('âš ï¸ Please select birth date', 'warning') : alert('Please select birth date');
                    return;
                }
                if (!formData.preferredBarber) {
                    showToast ? showToast('âš ï¸ Please select preferred barber', 'warning') : alert('Please select preferred barber');
                    return;
                }

                // Update client
                const updatedClient = {
                    ...client,
                    ...formData
                };
                updateClient(updatedClient);
                navigate('client-updated-success', updatedClient);
            };

            if (!client) {
                return (
                    <div class="bg-[#1C1E21] text-white font-display antialiased min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <p class="text-slate-400 mb-4">No client selected</p>
                            <button onClick={() => navigate('dashboard')} class="px-6 py-3 bg-[#FA383E] rounded-xl font-bold">Back to Dashboard</button>
                        </div>
                    </div>
                );
            }

            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21] overflow-x-hidden font-display">
                    {/* Header */}
                    <div class="sticky top-0 z-10 flex items-center justify-between bg-[#1C1E21] p-4 pb-2 border-b border-white/5">
                        <button onClick={() => navigate('client-profile', client)} class="flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-white/10 transition-colors">
                            <span class="material-symbols-outlined text-white" style={{fontSize: '24px'}}>arrow_back</span>
                        </button>
                        <h2 class="text-white text-xl font-bold leading-tight tracking-tight flex-1 text-center pr-10">Edit Client</h2>
                    </div>
                    
                    {/* Form Content */}
                    <div class="flex-1 flex flex-col px-6 pt-8 pb-32 gap-6">
                        
                        {/* Full Name */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="name">Full Name *</label>
                            <input 
                                className="flex w-full h-14 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-normal text-white placeholder:text-gray-500 focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all" 
                                id="name"
                                name="name"
                                value={formData.name}
                                onChange={handleChange}
                                placeholder="e.g., John Doe" 
                                type="text"
                            />
                        </div>
                        
                        {/* Phone Number */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="phone">Phone Number *</label>
                            <input 
                                className="flex w-full h-14 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-normal text-white placeholder:text-gray-500 focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all" 
                                id="phone"
                                name="phone"
                                value={formData.phone}
                                onChange={handleChange}
                                placeholder="e.g., +1 (555) 123-4567" 
                                type="tel"
                            />
                        </div>
                        
                        {/* Email */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="email">Email *</label>
                            <input 
                                className="flex w-full h-14 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-normal text-white placeholder:text-gray-500 focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all" 
                                id="email"
                                name="email"
                                value={formData.email}
                                onChange={handleChange}
                                placeholder="e.g., john@email.com" 
                                type="email"
                            />
                        </div>
                        
                        {/* Birth Date */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="birthDate">Birth Date *</label>
                            <input 
                                className="flex w-full h-14 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-normal text-white placeholder:text-gray-500 focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all" 
                                id="birthDate"
                                name="birthDate"
                                value={formData.birthDate}
                                onChange={handleChange}
                                type="date"
                            />
                        </div>

                        {/* Preferred Barber */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="preferredBarber">Preferred Barber *</label>
                            <select 
                                className="w-full h-14 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-normal text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all" 
                                id="preferredBarber"
                                name="preferredBarber"
                                value={formData.preferredBarber}
                                onChange={handleChange}
                            >
                                <option value="">Select a preference</option>
                                <option value="Juan">Juan</option>
                                <option value="Nico">Nico</option>
                                <option value="Pedro">Pedro</option>
                            </select>
                        </div>
                        
                        {/* Notes */}
                        <div className="flex flex-col gap-2">
                            <label className="text-white text-base font-medium leading-normal" htmlFor="notes">Notes</label>
                            <textarea 
                                className="flex w-full min-h-32 rounded-xl border-none bg-[#2A2D31] p-4 text-base font-normal text-white placeholder:text-gray-500 focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all resize-vertical" 
                                id="notes"
                                name="notes"
                                value={formData.notes}
                                onChange={handleChange}
                                placeholder="Add notes about this client (preferences, allergies, special requests, etc.)"
                            />
                        </div>
                    </div>
                    
                    {/* Submit Button */}
                    <div class="fixed bottom-0 left-0 right-0 z-20 bg-[#1C1E21] p-6 border-t border-white/5 pb-8">
                        <button onClick={handleSubmit} class="flex w-full items-center justify-center rounded-xl bg-[#FA383E] h-14 px-4 shadow-lg shadow-[#FA383E]/20 active:scale-[0.98] transition-transform">
                            <span class="text-white text-base font-bold leading-normal tracking-wide">Save Changes</span>
                        </button>
                    </div>
                </div>
            );
        }

        // Client Added Success Component
        function ClientAddedSuccess({ navigate, client }) {
            return (
                <div class="bg-[#1C1E21] text-white font-display antialiased min-h-screen flex flex-col relative overflow-hidden">
                    {/* Success Background */}
                    <div class="absolute inset-0 pointer-events-none opacity-30">
                        <span class="material-symbols-outlined absolute text-green-500 text-xl animate-pulse" style={{top: '15%', left: '10%'}}>check_circle</span>
                        <span class="material-symbols-outlined absolute text-green-500/60 text-sm" style={{top: '25%', right: '15%'}}>person_add</span>
                        <span class="material-symbols-outlined absolute text-green-500 text-2xl" style={{bottom: '30%', left: '5%'}}>verified</span>
                        <span class="material-symbols-outlined absolute text-green-500/50 text-xs" style={{bottom: '40%', right: '10%'}}>star</span>
                    </div>
                    
                    {/* Main Content */}
                    <div class="flex-1 flex flex-col items-center justify-center w-full max-w-md mx-auto px-6 z-10">
                        {/* Success Icon */}
                        <div class="relative w-32 h-32 mb-8">
                            <div class="absolute inset-0 bg-green-500/30 rounded-full blur-2xl"></div>
                            <div class="relative w-32 h-32 rounded-full bg-green-500/20 flex items-center justify-center border-4 border-green-500">
                                <span class="material-symbols-outlined text-green-500 text-6xl">check_circle</span>
                            </div>
                        </div>
                        
                        {/* Title */}
                        <h1 class="text-white text-3xl font-bold tracking-tight text-center mb-3">
                            Client Added Successfully!
                        </h1>
                        
                        {/* Description */}
                        <p class="text-slate-400 text-center leading-relaxed mb-8">
                            {client?.name} has been added to your client list.
                        </p>
                        
                        {/* Info Card */}
                        <div class="w-full bg-[#2A2D31] border border-white/10 rounded-xl p-6 mb-8">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="bg-[#FA383E]/20 p-3 rounded-full">
                                    <span class="material-symbols-outlined text-[#FA383E] text-2xl">person</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-xs uppercase tracking-widest text-slate-500 font-semibold mb-1">New Client</p>
                                    <p class="text-white text-xl font-bold">{client?.name}</p>
                                </div>
                            </div>
                            <div class="h-px bg-white/10 mb-4"></div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Phone</span>
                                    <span class="text-white font-medium">{client?.phone}</span>
                                </div>
                                {client?.preferredBarber && (
                                    <div class="flex justify-between">
                                        <span class="text-slate-400">Preferred Barber</span>
                                        <span class="text-white font-medium">{client.preferredBarber}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* Bottom Buttons */}
                    <div class="p-6 space-y-3 z-10">
                        <button onClick={() => navigate('client-profile', client)} class="w-full bg-[#FA383E] text-white h-14 rounded-xl font-bold text-base hover:bg-[#F35369] active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                            <span>View Client Profile</span>
                            <span class="material-symbols-outlined">arrow_forward</span>
                        </button>
                        <button onClick={() => navigate('dashboard')} class="w-full bg-[#2A2D31] text-white h-14 rounded-xl font-semibold text-base hover:bg-[#35383D] active:scale-[0.98] transition-all">
                            Back to Dashboard
                        </button>
                    </div>
                </div>
            );
        }

        // Client Updated Success Component
        function ClientUpdatedSuccess({ navigate, client }) {
            return (
                <div class="bg-[#1C1E21] text-white font-display antialiased min-h-screen flex flex-col relative overflow-hidden">
                    {/* Success Background */}
                    <div class="absolute inset-0 pointer-events-none opacity-30">
                        <span class="material-symbols-outlined absolute text-blue-500 text-xl animate-pulse" style={{top: '15%', left: '10%'}}>check_circle</span>
                        <span class="material-symbols-outlined absolute text-blue-500/60 text-sm" style={{top: '25%', right: '15%'}}>edit</span>
                        <span class="material-symbols-outlined absolute text-blue-500 text-2xl" style={{bottom: '30%', left: '5%'}}>verified</span>
                        <span class="material-symbols-outlined absolute text-blue-500/50 text-xs" style={{bottom: '40%', right: '10%'}}>star</span>
                    </div>
                    
                    {/* Main Content */}
                    <div class="flex-1 flex flex-col items-center justify-center w-full max-w-md mx-auto px-6 z-10">
                        {/* Success Icon */}
                        <div class="relative w-32 h-32 mb-8">
                            <div class="absolute inset-0 bg-blue-500/30 rounded-full blur-2xl"></div>
                            <div class="relative w-32 h-32 rounded-full bg-blue-500/20 flex items-center justify-center border-4 border-blue-500">
                                <span class="material-symbols-outlined text-blue-500 text-6xl">check_circle</span>
                            </div>
                        </div>
                        
                        {/* Title */}
                        <h1 class="text-white text-3xl font-bold tracking-tight text-center mb-3">
                            Changes Saved!
                        </h1>
                        
                        {/* Description */}
                        <p class="text-slate-400 text-center leading-relaxed mb-8">
                            {client?.name}'s information has been updated successfully.
                        </p>
                        
                        {/* Info Card */}
                        <div class="w-full bg-[#2A2D31] border border-white/10 rounded-xl p-6 mb-8">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="bg-blue-500/20 p-3 rounded-full">
                                    <span class="material-symbols-outlined text-blue-500 text-2xl">person</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-xs uppercase tracking-widest text-slate-500 font-semibold mb-1">Updated Client</p>
                                    <p class="text-white text-xl font-bold">{client?.name}</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-green-500/10 border border-green-500/20">
                                <span class="material-symbols-outlined text-green-500 text-sm">check</span>
                                <span class="text-green-500 text-sm font-medium">All changes saved</span>
                            </div>
                        </div>
                    </div>
                    
                    {/* Bottom Buttons */}
                    <div class="p-6 space-y-3 z-10">
                        <button onClick={() => navigate('client-profile', client)} class="w-full bg-[#FA383E] text-white h-14 rounded-xl font-bold text-base hover:bg-[#F35369] active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                            <span>View Client Profile</span>
                            <span class="material-symbols-outlined">arrow_forward</span>
                        </button>
                        <button onClick={() => navigate('dashboard')} class="w-full bg-[#2A2D31] text-white h-14 rounded-xl font-semibold text-base hover:bg-[#35383D] active:scale-[0.98] transition-all">
                            Back to Dashboard
                        </button>
                    </div>
                </div>
            );
        }

        // Client Deleted Success Component
        function ClientDeletedSuccess({ navigate, client }) {
            return (
                <div class="bg-[#1C1E21] text-white font-display antialiased min-h-screen flex flex-col relative overflow-hidden">
                    {/* Success Background */}
                    <div class="absolute inset-0 pointer-events-none opacity-30">
                        <span class="material-symbols-outlined absolute text-red-500 text-xl animate-pulse" style={{top: '15%', left: '10%'}}>check_circle</span>
                        <span class="material-symbols-outlined absolute text-red-500/60 text-sm" style={{top: '25%', right: '15%'}}>delete</span>
                        <span class="material-symbols-outlined absolute text-red-500 text-2xl" style={{bottom: '30%', left: '5%'}}>person_remove</span>
                        <span class="material-symbols-outlined absolute text-red-500/50 text-xs" style={{bottom: '40%', right: '10%'}}>delete_forever</span>
                    </div>
                    
                    {/* Main Content */}
                    <div class="flex-1 flex flex-col items-center justify-center w-full max-w-md mx-auto px-6 z-10">
                        {/* Success Icon */}
                        <div class="relative w-32 h-32 mb-8">
                            <div class="absolute inset-0 bg-red-500/30 rounded-full blur-2xl"></div>
                            <div class="relative w-32 h-32 rounded-full bg-red-500/20 flex items-center justify-center border-4 border-red-500">
                                <span class="material-symbols-outlined text-red-500 text-6xl">delete</span>
                            </div>
                        </div>
                        
                        {/* Title */}
                        <h1 class="text-white text-3xl font-bold tracking-tight text-center mb-3">
                            Client Deleted
                        </h1>
                        
                        {/* Description */}
                        <p class="text-slate-400 text-center leading-relaxed mb-8">
                            {client?.name} has been removed from your client list. Visit history has been preserved for records.
                        </p>
                        
                        {/* Info Card */}
                        <div class="w-full bg-[#2A2D31] border border-white/10 rounded-xl p-6 mb-8">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="bg-red-500/20 p-3 rounded-full">
                                    <span class="material-symbols-outlined text-red-500 text-2xl">person_off</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-xs uppercase tracking-widest text-slate-500 font-semibold mb-1">Deleted Client</p>
                                    <p class="text-white text-xl font-bold">{client?.name}</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-green-500/10 border border-green-500/20">
                                <span class="material-symbols-outlined text-green-500 text-sm">history</span>
                                <span class="text-green-500 text-sm font-medium">Visit history preserved</span>
                            </div>
                        </div>
                    </div>
                    
                    {/* Bottom Buttons */}
                    <div class="p-6 space-y-3 z-10">
                        <button onClick={() => navigate('clients-list')} class="w-full bg-[#FA383E] text-white h-14 rounded-xl font-bold text-base hover:bg-[#F35369] active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                            <span>View All Clients</span>
                            <span class="material-symbols-outlined">arrow_forward</span>
                        </button>
                        <button onClick={() => navigate('dashboard')} class="w-full bg-[#2A2D31] text-white h-14 rounded-xl font-semibold text-base hover:bg-[#35383D] active:scale-[0.98] transition-all">
                            Back to Dashboard
                        </button>
                    </div>
                </div>
            );
        }

        // Record Service Component
        function RecordService({ navigate, client, clients, setClients, addActivity, showToast }) {
            // Load barbers from localStorage
            const [barbers, setBarbers] = React.useState([]);
            const [selectedService, setSelectedService] = React.useState('fade');
            const [selectedBarber, setSelectedBarber] = React.useState('');
            const [notes, setNotes] = React.useState('');
            
            const [services, setServices] = React.useState([
                {id: 'fade', name: 'Fade', icon: 'content_cut'},
                {id: 'beard', name: 'Beard', icon: 'face'},
                {id: 'fullcut', name: 'Full Cut', icon: 'cut'},
                {id: 'scissors', name: 'Scissors', icon: 'content_cut'},
            ]);

            React.useEffect(() => {
                const storedBarbers = JSON.parse(localStorage.getItem('barberapp_barbers') || '["Juan", "Nico", "Pedro"]');
                setBarbers(storedBarbers);
                
                // Load services
                const storedServices = localStorage.getItem('barberapp_services');
                if (storedServices) {
                    setServices(JSON.parse(storedServices));
                } else {
                    // Initialize if empty
                    localStorage.setItem('barberapp_services', JSON.stringify(services));
                }

                // Set first barber as default
                if (storedBarbers.length > 0) {
                    const firstBarber = typeof storedBarbers[0] === 'string' ? storedBarbers[0] : storedBarbers[0].name;
                    setSelectedBarber(firstBarber);
                }
            }, []);
            
            const handleConfirmVisit = () => {
                if (!client) {
                    showToast ? showToast('âš ï¸ No client selected', 'warning') : alert('No client selected');
                    return;
                }
                
                // Get service name
                const serviceName = services.find(s => s.id === selectedService)?.name || 'Service';
                
                // Update client visits
                const newVisits = (client.visits || 0) + 1;
                const updatedClient = {
                    ...client,
                    visits: newVisits,
                    lastVisit: new Date().toISOString().split('T')[0]
                };
                
                // Update clients array
                setClients(prev => prev.map(c => 
                    c.id === client.id ? updatedClient : c
                ));
                
                // Add activity to recent activities
                addActivity({
                    clientId: client.id,
                    clientName: client.name,
                    service: serviceName,
                    barber: selectedBarber,
                    notes: notes,
                    date: new Date().toISOString().split('T')[0]
                });
                
                // Check if visits is a multiple of 10
                if (newVisits % 10 === 0) {
                    // Navigate to prize screen
                    navigate('prize-redeemed', updatedClient);
                } else {
                    // Go back to client profile
                    navigate('client-profile', updatedClient);
                }
            };
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21]">
                    <header class="flex items-center justify-between p-4 pb-2 z-10 bg-[#1C1E21]/90 backdrop-blur-md sticky top-0 border-b border-white/5">
                        <button onClick={() => navigate('client-profile', client)} class="flex size-10 items-center justify-center rounded-full text-white hover:bg-white/5 transition-colors">
                            <span class="material-symbols-outlined text-[24px]">close</span>
                        </button>
                        <h1 class="text-lg font-bold leading-tight tracking-tight text-white flex-1 text-center pr-10">
                            Record Visit
                        </h1>
                    </header>
                    
                    <main class="flex-1 overflow-y-auto no-scrollbar pb-32 px-4 pt-6">
                        <div class="flex flex-col gap-6">
                            {/* Barber Selection */}
                            <div class="flex flex-col gap-2">
                                <label class="text-slate-400 text-sm font-medium ml-1">Barber Name</label>
                                <select 
                                    value={selectedBarber}
                                    onChange={(e) => setSelectedBarber(e.target.value)}
                                    class="w-full bg-[#2A2D31] border-none rounded-xl h-14 pl-4 pr-12 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-[#FA383E] transition-all">
                                    {barbers.map((barber, index) => {
                                        const barberName = typeof barber === 'string' ? barber : barber.name;
                                        return <option key={index} value={barberName}>{barberName}</option>;
                                    })}
                                </select>
                            </div>
                            
                            {/* Service Type Selection */}
                            <div class="flex flex-col gap-3">
                                <div class="flex items-center justify-between">
                                    <label class="text-slate-400 text-sm font-medium ml-1">Service Type</label>
                                    <span class="text-xs font-medium text-slate-500">Select one</span>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    {services.map((service) => (
                                        <button 
                                            key={service.id}
                                            onClick={() => setSelectedService(service.id)}
                                            class={`relative h-24 rounded-xl flex flex-col items-center justify-center gap-2 transition-all active:scale-95 ${
                                                selectedService === service.id 
                                                    ? 'bg-[#FA383E] text-white border-2 border-[#FA383E] shadow-lg shadow-[#FA383E]/20' 
                                                    : 'bg-[#2A2D31] border border-white/5 text-slate-400 hover:border-[#FA383E]/50 hover:bg-[#2A2D31]'
                                            }`}
                                        >
                                            {selectedService === service.id && (
                                                <div class="absolute top-2 right-2">
                                                    <span class="material-symbols-outlined text-[20px] font-bold">check_circle</span>
                                                </div>
                                            )}
                                            <span class={`material-symbols-outlined text-[28px] ${selectedService === service.id ? '' : 'opacity-70'}`}>{service.icon}</span>
                                            <span class="text-base font-bold">{service.name}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Client Notes */}
                            <div class="flex flex-col gap-2">
                                <label class="text-slate-400 text-sm font-medium ml-1">Client Notes</label>
                                <textarea 
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                    class="w-full bg-[#2A2D31] border-none rounded-xl min-h-[100px] p-4 text-base text-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-[#FA383E] resize-none transition-all" 
                                    placeholder="Any specific requests or details..."
                                ></textarea>
                            </div>
                            
                            {/* Photo Upload */}
                            <div class="flex flex-col gap-2">
                                <label class="text-slate-400 text-sm font-medium ml-1">Result Photo</label>
                                <button class="group w-full h-20 rounded-xl border-2 border-dashed border-white/20 hover:border-[#FA383E] bg-[#2A2D31]/50 flex items-center justify-center gap-3 transition-all active:scale-[0.98]">
                                    <div class="size-10 rounded-full bg-white/10 flex items-center justify-center group-hover:bg-[#FA383E]/20">
                                        <span class="material-symbols-outlined text-slate-400 group-hover:text-[#FA383E]">add_a_photo</span>
                                    </div>
                                    <span class="text-sm font-medium text-slate-400 group-hover:text-[#FA383E]">Tap to upload photo</span>
                                </button>
                            </div>
                            
                            <div class="h-10"></div>
                        </div>
                    </main>
                    
                    {/* Bottom Actions */}
                    <div class="absolute bottom-0 left-0 right-0 z-20 p-5 flex flex-col gap-4 bg-gradient-to-t from-[#1C1E21] via-[#1C1E21]/95 to-transparent pt-12">
                        {/* Confirm Button */}
                        <button onClick={handleConfirmVisit} class="w-full h-14 bg-[#FA383E] text-white rounded-xl font-bold text-lg shadow-lg shadow-[#FA383E]/25 hover:bg-[#F35369] active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                            <span>Confirm Visit</span>
                            <span class="material-symbols-outlined text-[20px]">arrow_forward</span>
                        </button>
                    </div>
                </div>
            );
        }

        // Prize Redeemed Component
        function PrizeRedeemed({ navigate, client }) {
            const visits = client?.visits || 10;
            return (
                <div class="bg-background-light dark:bg-background-dark font-display min-h-screen flex flex-col relative overflow-hidden">
                    {/* Sparkle Background */}
                    <div class="absolute inset-0 pointer-events-none opacity-40">
                        <span class="material-symbols-outlined absolute text-primary text-xl animate-pulse" style={{top: '15%', left: '10%'}}>star</span>
                        <span class="material-symbols-outlined absolute text-primary/60 text-sm" style={{top: '20%', right: '15%'}}>circle</span>
                        <span class="material-symbols-outlined absolute text-primary text-2xl" style={{bottom: '30%', left: '5%'}}>auto_awesome</span>
                        <span class="material-symbols-outlined absolute text-primary/50 text-xs" style={{bottom: '40%', right: '10%'}}>diamond</span>
                        <span class="material-symbols-outlined absolute text-primary/30 text-lg" style={{top: '50%', left: '20%'}}>star</span>
                        <span class="material-symbols-outlined absolute text-white/20 text-xl" style={{top: '10%', right: '5%'}}>hotel_class</span>
                    </div>
                    
                    {/* Close Button */}
                    <div class="relative z-10 flex items-center justify-between p-6">
                        <button onClick={() => navigate('dashboard')} class="flex items-center justify-center size-10 rounded-full bg-white/5 text-white hover:bg-white/10 transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    
                    {/* Main Content */}
                    <div class="flex-1 flex flex-col items-center justify-center w-full max-w-md mx-auto px-6 pb-20 z-10">
                        {/* Trophy Image */}
                        <div class="relative w-full flex justify-center mb-8">
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 bg-primary/30 rounded-full blur-[60px]"></div>
                            <div class="relative w-48 h-48 bg-cover bg-center drop-shadow-2xl" style={{
                                backgroundImage: "url('https://lh3.googleusercontent.com/aida-public/AB6AXuCbfQPVBQvGd_wuDqtRBWcUCuKpKTvq7P9w4aGoBShqN9SePc24-sX9UZ5Op-U3GpdlHqoInhclV8Z9X9BGWHayWdNAPePCHJFHmft8ywv9dqJ6S6cUHrA4wyobUmKtYqltxN9fnE9EnMg1K3fTCh2-R6JMAx9vh8a6tt3ZBxz1V32GlLiHq1ADoOcMhw6ihn4JecwtiPE8RgINJkR2cfwXyUhHNu3jSMd82VKNrNIZKbSc4xX4cYwA327FDv3OAQGFL8LiSbKhZWoF')",
                                WebkitMaskImage: "radial-gradient(circle, black 60%, transparent 100%)",
                                maskImage: "radial-gradient(circle, black 60%, transparent 100%)"
                            }}></div>
                        </div>
                        
                        {/* Title */}
                        <h1 class="text-primary text-4xl md:text-5xl font-bold tracking-tight text-center mb-2 drop-shadow-lg italic">
                            REWARD REDEEMED!
                        </h1>
                        
                        {/* Description */}
                        <p class="text-white/80 text-lg text-center leading-relaxed mb-8 px-4">
                            Congratulations! You've successfully unlocked your {visits}th visit perk.
                        </p>
                        
                        {/* Info Card */}
                        <div class="w-full bg-white/5 border border-white/10 rounded-xl p-6 backdrop-blur-sm shadow-xl">
                            <div class="flex flex-col gap-4">
                                {/* Client Info */}
                                <div class="flex items-center gap-4">
                                    <div class="bg-primary/20 p-2 rounded-full text-primary shrink-0">
                                        <span class="material-symbols-outlined text-2xl">person</span>
                                    </div>
                                    <div>
                                        <p class="text-xs uppercase tracking-widest text-white/50 font-semibold mb-0.5">Client</p>
                                        <p class="text-white text-xl font-medium">{client?.name || 'Client'}</p>
                                    </div>
                                </div>
                                
                                {/* Divider */}
                                <div class="h-px w-full bg-gradient-to-r from-transparent via-primary/30 to-transparent my-1"></div>
                                
                                {/* Reward Info */}
                                <div class="flex items-center gap-4">
                                    <div class="bg-primary/20 p-2 rounded-full text-primary shrink-0">
                                        <span class="material-symbols-outlined text-2xl">redeem</span>
                                    </div>
                                    <div>
                                        <p class="text-xs uppercase tracking-widest text-white/50 font-semibold mb-0.5">Reward</p>
                                        <p class="text-white text-xl font-medium">Free Premium Fade</p>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Success Badge */}
                            <div class="mt-6 flex justify-center">
                                <div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-primary/10 border border-primary/20">
                                    <span class="material-symbols-outlined text-primary text-sm">check_circle</span>
                                    <span class="text-primary text-sm font-medium">Redeemed Successfully</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Bottom Button */}
                    <div class="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-background-dark via-background-dark/95 to-transparent z-20">
                        <button onClick={() => navigate('dashboard')} class="w-full bg-red-600 text-white h-14 rounded-lg font-bold text-lg hover:bg-red-700 active:scale-[0.98] transition-all flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(220,38,38,0.3)]">
                            <span>Back to Dashboard</span>
                            <span class="material-symbols-outlined">arrow_forward</span>
                        </button>
                    </div>
                </div>
            );
        }
        
        // Settings Component
        function Settings({ navigate, user, handleLogout }) {
            const [barbers, setBarbers] = React.useState([]);
            const [servicePrices, setServicePrices] = React.useState({});
            const [businessInfo, setBusinessInfo] = React.useState({});
            const [loading, setLoading] = React.useState(true);
            
            // Load settings from Firebase/localStorage
            React.useEffect(() => {
                const loadSettings = async () => {
                    setLoading(true);
                    try {
                        // Load barbers
                        let barbersData = await FirebaseService.getSettings('barbers');
                        if (!barbersData) {
                            barbersData = JSON.stringify(['Juan', 'Nico', 'Pedro']);
                            await FirebaseService.saveSetting('barbers', barbersData);
                        }
                        setBarbers(JSON.parse(barbersData));
                        console.log('âœ… Loaded barbers:', JSON.parse(barbersData));
                        
                        // Load service prices
                        let pricesData = await FirebaseService.getSettings('service_prices');
                        if (!pricesData) {
                            pricesData = JSON.stringify({
                                'Fade': 30,
                                'Beard': 20,
                                'Full Cut': 45,
                                'Scissors': 35
                            });
                            await FirebaseService.saveSetting('service_prices', pricesData);
                        }
                        setServicePrices(JSON.parse(pricesData));
                        console.log('âœ… Loaded service prices:', JSON.parse(pricesData));
                        
                        // Load business info
                        let businessData = await FirebaseService.getSettings('business_info');
                        if (!businessData) {
                            businessData = JSON.stringify({
                                name: 'HOR. Barber',
                                phone: '+1 (555) 000-0000',
                                address: '123 Main Street, City',
                                email: 'contact@horbarber.com'
                            });
                            await FirebaseService.saveSetting('business_info', businessData);
                        }
                        setBusinessInfo(JSON.parse(businessData));
                        console.log('âœ… Loaded business info:', JSON.parse(businessData));
                    } catch (error) {
                        console.error('Error loading settings:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                
                loadSettings();
            }, []);
            
            // Save barbers whenever they change
            React.useEffect(() => {
                if (!loading) {
                    console.log('ðŸ” Barbers changed, will save:', barbers);
                    if (barbers.length > 0) {
                        const saveBarbers = async () => {
                            const success = await FirebaseService.saveSetting('barbers', JSON.stringify(barbers));
                            console.log('ðŸ’¾ Saved barbers:', barbers, 'Success:', success);
                        };
                        saveBarbers();
                    } else {
                        console.warn('âš ï¸ Barbers array is empty, not saving');
                    }
                }
            }, [barbers, loading]);
            
            // Save service prices whenever they change
            React.useEffect(() => {
                if (!loading) {
                    console.log('ðŸ” Service prices changed, will save:', servicePrices);
                    if (Object.keys(servicePrices).length > 0) {
                        const savePrices = async () => {
                            const success = await FirebaseService.saveSetting('service_prices', JSON.stringify(servicePrices));
                            console.log('ðŸ’¾ Saved service prices:', servicePrices, 'Success:', success);
                        };
                        savePrices();
                    } else {
                        console.warn('âš ï¸ Service prices object is empty, not saving');
                    }
                }
            }, [servicePrices, loading]);
            
            // Save business info whenever it changes
            React.useEffect(() => {
                if (!loading) {
                    console.log('ðŸ” Business info changed, will save:', businessInfo);
                    if (Object.keys(businessInfo).length > 0) {
                        const saveInfo = async () => {
                            const success = await FirebaseService.saveSetting('business_info', JSON.stringify(businessInfo));
                            console.log('ðŸ’¾ Saved business info:', businessInfo, 'Success:', success);
                        };
                        saveInfo();
                    } else {
                        console.warn('âš ï¸ Business info object is empty, not saving');
                    }
                }
            }, [businessInfo, loading]);
            
            if (loading) {
                return (
                    <div class="flex items-center justify-center min-h-screen bg-[#1C1E21]">
                        <div class="text-center">
                            <img 
                                src="Images/hor-barber-logo.png" 
                                class="h-20 w-20 object-contain mx-auto mb-4 animate-[spin_3s_linear_infinite]" 
                                alt="Loading..." 
                            />
                            <p class="text-white text-lg font-bold tracking-tight">Loading...</p>
                        </div>
                    </div>
                );
            }
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21] pb-20">
                    {/* Header with logo */}
                    <div class="flex items-center gap-3 p-4 justify-between border-b border-white/5">
                        <img src="./Images/hor-barber-logo.png" alt="HOR. Barber" class="h-10 scale-125" />
                        <h2 class="text-white text-lg font-bold flex-1 text-center">Settings</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    {/* Settings Content */}
                    <div class="flex-1 p-4 space-y-4 overflow-y-auto">
                        {/* Account Section */}
                        <div class="space-y-2">
                            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider px-2 mb-3">Account</h3>
                            <button onClick={() => navigate('manage-barbers', { barbers, setBarbers })} class="w-full bg-[#2A2D31] rounded-xl p-4 flex items-center justify-between hover:bg-[#35383D] transition-colors border border-white/5">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-[#FA383E]/20 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-[#FA383E]">group</span>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-white font-semibold">Manage Barbers</p>
                                        <p class="text-slate-400 text-sm">{barbers.length} barbers registered</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-slate-500">chevron_right</span>
                            </button>
                            
                            <button onClick={() => navigate('business-info', { businessInfo, setBusinessInfo })} class="w-full bg-[#2A2D31] rounded-xl p-4 flex items-center justify-between hover:bg-[#35383D] transition-colors border border-white/5">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-[#FA383E]/20 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-[#FA383E]">store</span>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-white font-semibold">Business Information</p>
                                        <p class="text-slate-400 text-sm">{businessInfo.name}</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-slate-500">chevron_right</span>
                            </button>
                        </div>
                        
                        {/* Business Section */}
                        <div class="space-y-2">
                            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider px-2 mb-3 mt-6">Business</h3>
                            <button onClick={() => navigate('reward-rules')} class="w-full bg-[#2A2D31] rounded-xl p-4 flex items-center justify-between hover:bg-[#35383D] transition-colors border border-white/5">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-[#FA383E]/20 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-[#FA383E]">diamond</span>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-white font-semibold">Reward Rules</p>
                                        <p class="text-slate-400 text-sm">Configure loyalty program</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-slate-500">chevron_right</span>
                            </button>
                            
                            <button onClick={() => navigate('service-prices', { servicePrices, setServicePrices })} class="w-full bg-[#2A2D31] rounded-xl p-4 flex items-center justify-between hover:bg-[#35383D] transition-colors border border-white/5">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-[#FA383E]/20 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-[#FA383E]">payments</span>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-white font-semibold">Services & Prices</p>
                                        <p class="text-slate-400 text-sm">Manage services and pricing</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-slate-500">chevron_right</span>
                            </button>
                            
                            <button onClick={() => navigate('barber-schedules', { barbers, setBarbers })} class="w-full bg-[#2A2D31] rounded-xl p-4 flex items-center justify-between hover:bg-[#35383D] transition-colors border border-white/5">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-[#FA383E]/20 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-[#FA383E]">schedule</span>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-white font-semibold">Barber Schedules</p>
                                        <p class="text-slate-400 text-sm">Configure work hours</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-slate-500">chevron_right</span>
                            </button>
                        </div>
                        
                        {/* App Section */}
                        <div class="space-y-2">
                            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider px-2 mb-3 mt-6">App</h3>
                            <button onClick={() => navigate('notifications')} class="w-full bg-[#2A2D31] rounded-xl p-4 flex items-center justify-between hover:bg-[#35383D] transition-colors border border-white/5">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-[#FA383E]/20 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-[#FA383E]">notifications</span>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-white font-semibold">Notifications</p>
                                        <p class="text-slate-400 text-sm">Birthdays and reminders</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-slate-500">chevron_right</span>
                            </button>

                            {/* Logout */}
                            <button onClick={handleLogout} class="w-full bg-red-500/10 rounded-xl p-4 flex items-center justify-between hover:bg-red-500/20 transition-colors border border-red-500/20 mt-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-red-500 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-white">logout</span>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-white font-semibold">Sign Out</p>
                                        <p class="text-slate-400 text-sm">{user ? user.email : 'Log out of app'}</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-slate-500">chevron_right</span>
                            </button>
                        </div>
                    </div>
                    <div class="fixed bottom-0 left-0 right-0 z-50 bg-[#1C1E21] border-t border-white/5">
                        <div class="flex items-center justify-around h-16">
                            <button onClick={() => navigate('dashboard')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">dashboard</span>
                                <span class="text-[10px] font-medium">Home</span>
                            </button>
                            <button onClick={() => navigate('clients-list')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">people</span>
                                <span class="text-[10px] font-medium">Clients</span>
                            </button>
                            <button onClick={() => navigate('analytics')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">bar_chart</span>
                                <span class="text-[10px] font-medium">Analytics</span>
                            </button>
                            <button onClick={() => navigate('settings')} class="flex flex-col items-center justify-center gap-1 p-2 text-[#FA383E]">
                                <span class="material-symbols-outlined">settings</span>
                                <span class="text-[10px] font-medium">Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Analytics Component
        function Analytics({ navigate, clients, activities }) {
            const [selectedPeriod, setSelectedPeriod] = React.useState('today'); // 'today', 'week', 'month', 'custom'
            const [customStartDate, setCustomStartDate] = React.useState('');
            const [customEndDate, setCustomEndDate] = React.useState('');
            const [showCustomDates, setShowCustomDates] = React.useState(false);
            
            // Service prices - Load from storage
            const servicePrices = React.useMemo(() => {
                try {
                    // Use correct scoped key
                    const prefix = FirebaseService.localPrefix || 'barberapp_';
                    const saved = localStorage.getItem(`${prefix}service_prices`);

                    // Default values just in case
                    return saved ? JSON.parse(saved) : {
                        'Fade': 30,
                        'Beard': 20,
                        'Full Cut': 45,
                        'Scissors': 35
                    };
                } catch (e) {
                    console.error("Error loading service prices in analytics", e);
                    return {};
                }
            }, []);
            
            // Service prices helper
            const getServicePrice = React.useCallback((serviceName) => {
                // 1. Direct match
                if (servicePrices[serviceName] !== undefined) {
                    return servicePrices[serviceName];
                }
                
                // 2. Try to match historical names to current IDs/Names
                // Load services definitions if available (cached)
                try {
                    const localDefs = localStorage.getItem('barberapp_services');
                    const servicesList = localDefs ? JSON.parse(localDefs) : [];
                    
                    // Known default mappings (Historical Name -> original ID)
                    const legacyMap = {
                        'Fade': 'fade',
                        'Beard': 'beard',
                        'Full Cut': 'fullcut',
                        'Scissors': 'scissors'
                    };
                    
                    const id = legacyMap[serviceName];
                    if (id) {
                        // Find what the name of this ID is NOW
                        const currentDef = servicesList.find(s => s.id === id);
                        if (currentDef && currentDef.name) {
                            // Look up price for CURRENT name
                            return servicePrices[currentDef.name] || 0;
                        }
                    }
                } catch(e) { console.error(e); }
                
                return 0;
            }, [servicePrices]);
            
            // Filter activities by period
            const getFilteredActivities = () => {
                const now = new Date();
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - 7);
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                
                return activities.filter(activity => {
                    const activityDate = new Date(activity.timestamp);
                    if (selectedPeriod === 'today') {
                        return activityDate >= startOfToday;
                    } else if (selectedPeriod === 'week') {
                        return activityDate >= startOfWeek;
                    } else if (selectedPeriod === 'month') {
                        return activityDate >= startOfMonth;
                    } else if (selectedPeriod === 'custom' && customStartDate && customEndDate) {
                        const start = new Date(customStartDate);
                        start.setHours(0, 0, 0, 0);
                        const end = new Date(customEndDate);
                        end.setHours(23, 59, 59, 999);
                        return activityDate >= start && activityDate <= end;
                    }
                    return true;
                });
            };
            
            // Get previous period activities for comparison
            const getPreviousPeriodActivities = () => {
                const now = new Date();
                let prevStart, prevEnd;
                
                if (selectedPeriod === 'today') {
                    prevEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    prevStart = new Date(prevEnd);
                    prevStart.setDate(prevStart.getDate() - 1);
                } else if (selectedPeriod === 'week') {
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - 7);
                    prevEnd = startOfWeek;
                    prevStart = new Date(startOfWeek);
                    prevStart.setDate(prevStart.getDate() - 7);
                } else if (selectedPeriod === 'month') {
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    prevEnd = startOfMonth;
                    prevStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                }
                
                return activities.filter(activity => {
                    const activityDate = new Date(activity.timestamp);
                    return activityDate >= prevStart && activityDate < prevEnd;
                });
            };
            
            const filteredActivities = getFilteredActivities();
            const previousActivities = getPreviousPeriodActivities();
            
            // Calculate revenue
            const revenue = filteredActivities.reduce((sum, activity) => {
                return sum + (getServicePrice(activity.service) || 0);
            }, 0);
            
            const prevRevenue = previousActivities.reduce((sum, activity) => {
                return sum + (getServicePrice(activity.service) || 0);
            }, 0);
            
            const formatNumber = (num) => {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            };
            
            const revenueChange = prevRevenue > 0 
                ? ((revenue - prevRevenue) / prevRevenue * 100).toFixed(0)
                : (revenue > 0 ? 100 : 0);
            
            // Count services
            const servicesCount = filteredActivities.length;
            const prevServicesCount = previousActivities.length;
            const servicesChange = prevServicesCount > 0
                ? ((servicesCount - prevServicesCount) / prevServicesCount * 100).toFixed(0)
                : (servicesCount > 0 ? 100 : 0);
            
            // New Clients Calculation (Based on Date Created or First Visit)
            const countNewClients = () => {
                const now = new Date();
                let startOfPeriod;
                
                if (selectedPeriod === 'today') {
                    startOfPeriod = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                } else if (selectedPeriod === 'week') {
                    const d = new Date(now);
                    d.setDate(d.getDate() - 7);
                    startOfPeriod = d;
                } else if (selectedPeriod === 'month') {
                    startOfPeriod = new Date(now.getFullYear(), now.getMonth(), 1);
                } else {
                    return 0; // Custom range logic omitted for brevity, adding if needed
                }
                
                // Method 1: Count clients created in this period (if we had createdAt)
                // Method 2 (Current): Count clients whose FIRST visit is in this period
                
                // 1. Get all unique clients who had activity in this period
                const activeClientIdsThisPeriod = new Set(filteredActivities.map(a => a.clientId));
                
                let count = 0;
                activeClientIdsThisPeriod.forEach(clientId => {
                    // Get ALL history for this client
                    const history = activities
                        .filter(a => a.clientId === clientId)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        
                    if(history.length > 0) {
                        const firstEverVisit = new Date(history[0].timestamp);
                        // If their first ever visit is >= start of this period, they are "New"
                        if (firstEverVisit >= startOfPeriod) {
                            count++;
                        }
                    }
                });
                
                return count;
            };

            const newClientsCount = countNewClients();
            
            // Average ticket
            const avgTicket = servicesCount > 0 ? (revenue / servicesCount).toFixed(0) : 0;
            const prevAvgTicket = prevServicesCount > 0 ? (prevRevenue / prevServicesCount).toFixed(0) : 0;
            const avgTicketChange = prevAvgTicket > 0
                ? ((avgTicket - prevAvgTicket) / prevAvgTicket * 100).toFixed(0)
                : (avgTicket > 0 ? 100 : 0);
            
            // Top services
            const serviceCount = {};
            filteredActivities.forEach(activity => {
                serviceCount[activity.service] = (serviceCount[activity.service] || 0) + 1;
            });
            
            const topServices = Object.entries(serviceCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const maxServiceCount = topServices.length > 0 ? topServices[0][1] : 1;
            
            // Top barbers
            const barberStats = {};
            filteredActivities.forEach(activity => {
                if (!barberStats[activity.barber]) {
                    barberStats[activity.barber] = { count: 0, revenue: 0 };
                }
                barberStats[activity.barber].count++;
                barberStats[activity.barber].revenue += (servicePrices[activity.service] || 0);
            });
            
            const topBarbers = Object.entries(barberStats)
                .map(([name, stats]) => ({ name, ...stats }))
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);
            
            const barberColors = {
                'Juan': '#FA383E',
                'Nico': '#F35369',
                'Pedro': '#FBCCD2'
            };
            
            const getPeriodLabel = () => {
                if (selectedPeriod === 'today') return 'yesterday';
                if (selectedPeriod === 'week') return 'last week';
                if (selectedPeriod === 'custom') return 'previous period';
                return 'last month';
            };
            
            const getPeriodDisplayName = () => {
                if (selectedPeriod === 'today') return 'Today';
                if (selectedPeriod === 'week') return 'Last 7 Days';
                if (selectedPeriod === 'month') return 'This Month';
                if (selectedPeriod === 'custom' && customStartDate && customEndDate) {
                    const start = new Date(customStartDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const end = new Date(customEndDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    return `${start} - ${end}`;
                }
                return 'Custom Range';
            };
            
            const handlePeriodChange = (e) => {
                const value = e.target.value;
                setSelectedPeriod(value);
                if (value === 'custom') {
                    setShowCustomDates(true);
                } else {
                    setShowCustomDates(false);
                }
            };
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21] pb-20">
                    {/* Header with logo */}
                    <div class="flex items-center gap-3 p-4 justify-between border-b border-white/5">
                        <img src="./Images/hor-barber-logo.png" alt="HOR. Barber" class="h-10 scale-125" />
                        <h2 class="text-white text-lg font-bold flex-1 text-center">Analytics</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    {/* Period Selector */}
                    <div class="p-4">
                        <div class="flex flex-col gap-3">
                            <select 
                                value={selectedPeriod} 
                                onChange={handlePeriodChange}
                                class="w-full h-12 rounded-xl border-none bg-[#2A2D31] px-4 text-base font-semibold text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none transition-all"
                            >
                                <option value="today">Today</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                            
                            {showCustomDates && (
                                <div class="flex gap-2">
                                    <div class="flex-1">
                                        <label class="text-slate-400 text-xs mb-1 block">Start Date</label>
                                        <input 
                                            type="date"
                                            value={customStartDate}
                                            onChange={(e) => setCustomStartDate(e.target.value)}
                                            class="w-full h-10 rounded-lg border-none bg-[#35383D] px-3 text-sm text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                                        />
                                    </div>
                                    <div class="flex-1">
                                        <label class="text-slate-400 text-xs mb-1 block">End Date</label>
                                        <input 
                                            type="date"
                                            value={customEndDate}
                                            onChange={(e) => setCustomEndDate(e.target.value)}
                                            class="w-full h-10 rounded-lg border-none bg-[#35383D] px-3 text-sm text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                                        />
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Stats Grid */}
                    <div class="px-4 grid grid-cols-2 gap-3 mb-6">
                        <div class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 rounded-lg bg-[#FA383E]/20 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[#FA383E] text-sm">payments</span>
                                </div>
                            </div>
                            <p class="text-slate-400 text-xs mb-1">Revenue</p>
                            <p class="text-white text-2xl font-bold">${formatNumber(revenue)}</p>
                            {revenueChange != 0 && (
                                <p class={`text-xs mt-1 ${revenueChange > 0 ? 'text-green-500' : 'text-red-500'}`}>
                                    {revenueChange > 0 ? 'â†‘' : 'â†“'} {Math.abs(revenueChange)}% vs {getPeriodLabel()}
                                </p>
                            )}
                        </div>
                        
                        <div class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 rounded-lg bg-[#FA383E]/20 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[#FA383E] text-sm">content_cut</span>
                                </div>
                            </div>
                            <p class="text-slate-400 text-xs mb-1">Total Services</p>
                            <p class="text-white text-2xl font-bold">{servicesCount}</p>
                            <p class="text-slate-500 text-xs mt-1">Haircuts completed</p>
                        </div>
                        
                        <div class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 rounded-lg bg-[#FA383E]/20 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[#FA383E] text-sm">person_add</span>
                                </div>
                            </div>
                            <p class="text-slate-400 text-xs mb-1">New Clients</p>
                            <p class="text-white text-2xl font-bold">{newClientsCount}</p>
                            <p class="text-slate-500 text-xs mt-1">This period</p>
                        </div>
                        
                        <div class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 rounded-lg bg-[#FA383E]/20 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[#FA383E] text-sm">trending_up</span>
                                </div>
                            </div>
                            <p class="text-slate-400 text-xs mb-1">Avg. Ticket</p>
                            <p class="text-white text-2xl font-bold">${formatNumber(avgTicket)}</p>
                            {avgTicketChange != 0 && (
                                <p class={`text-xs mt-1 ${avgTicketChange > 0 ? 'text-green-500' : 'text-red-500'}`}>
                                    {avgTicketChange > 0 ? 'â†‘' : 'â†“'} {Math.abs(avgTicketChange)}% vs {getPeriodLabel()}
                                </p>
                            )}
                        </div>
                    </div>
                    
                    {/* Top Services */}
                    <div class="px-4 mb-6">
                        <h3 class="text-white text-lg font-bold mb-3">Most Popular Services</h3>
                        {topServices.length > 0 ? (
                            <div class="space-y-2">
                                {topServices.map(([service, count]) => {
                                    const price = getServicePrice(service) || 0;
                                    const revenue = count * price;
                                    return (
                                        <div key={service} class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                                            <div class="flex items-center justify-between mb-3">
                                                <div>
                                                    <p class="text-white font-semibold">{service}</p>
                                                    <p class="text-slate-400 text-xs mt-0.5">${formatNumber(price)} per service</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-[#FA383E] font-bold">{count} times</p>
                                                    <p class="text-slate-400 text-xs">${formatNumber(revenue)} total</p>
                                                </div>
                                            </div>
                                            <div class="w-full bg-white/10 rounded-full h-2">
                                                <div class="bg-[#FA383E] h-2 rounded-full" style={{width: `${(count / maxServiceCount) * 100}%`}}></div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div class="bg-[#2A2D31] rounded-xl p-8 border border-white/5 text-center">
                                <span class="material-symbols-outlined text-slate-600 text-4xl mb-2 block">content_cut</span>
                                <p class="text-slate-500">No services in this period</p>
                            </div>
                        )}
                    </div>
                    
                    {/* Top Barbers */}
                    <div class="px-4 mb-6">
                        <h3 class="text-white text-lg font-bold mb-3">Top Barbers</h3>
                        {topBarbers.length > 0 ? (
                            <div class="space-y-2">
                                {topBarbers.map((barber) => (
                                    <div key={barber.name} class="bg-[#2A2D31] rounded-xl p-4 border border-white/5 flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div 
                                                class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" 
                                                style={{backgroundColor: barberColors[barber.name] || '#FA383E'}}
                                            >
                                                {barber.name.charAt(0)}
                                            </div>
                                            <div>
                                                <p class="text-white font-semibold">{barber.name}</p>
                                                <p class="text-slate-400 text-sm">{barber.count} services</p>
                                            </div>
                                        </div>
                                        <p class="text-[#FA383E] font-bold">${barber.revenue}</p>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div class="bg-[#2A2D31] rounded-xl p-8 border border-white/5 text-center">
                                <span class="material-symbols-outlined text-slate-600 text-4xl mb-2 block">person</span>
                                <p class="text-slate-500">No barber data in this period</p>
                            </div>
                        )}
                    </div>
                    <div class="fixed bottom-0 left-0 right-0 z-50 bg-[#1C1E21] border-t border-white/5">
                        <div class="flex items-center justify-around h-16">
                            <button onClick={() => navigate('dashboard')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">dashboard</span>
                                <span class="text-[10px] font-medium">Home</span>
                            </button>
                            <button onClick={() => navigate('clients-list')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">people</span>
                                <span class="text-[10px] font-medium">Clients</span>
                            </button>
                            <button onClick={() => navigate('analytics')} class="flex flex-col items-center justify-center gap-1 p-2 text-[#FA383E]">
                                <span class="material-symbols-outlined">bar_chart</span>
                                <span class="text-[10px] font-medium">Analytics</span>
                            </button>
                            <button onClick={() => navigate('settings')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">settings</span>
                                <span class="text-[10px] font-medium">Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ClientsList Component  
        function ClientsList({ navigate, clients, deleteClient }) {
            const [searchQuery, setSearchQuery] = React.useState('');
            const [filterType, setFilterType] = React.useState('all'); // 'all' or 'recent'
            
            const getFilteredClients = () => {
                let filtered = clients;
                
                // Apply time filter
                if (filterType === 'recent') {
                    const tenDaysAgo = new Date();
                    tenDaysAgo.setDate(tenDaysAgo.getDate() - 10);
                    filtered = clients.filter(client => {
                        if (!client.lastVisit) return false;
                        const lastVisitDate = new Date(client.lastVisit);
                        return lastVisitDate >= tenDaysAgo;
                    });
                    // Recent: sort by last visit, descending
                    filtered.sort((a, b) => new Date(b.lastVisit) - new Date(a.lastVisit));
                } else {
                    // All: sort by birth date, oldest first
                    filtered = [...clients].sort((a, b) => {
                        if (!a.birthDate) return 1;
                        if (!b.birthDate) return -1;
                        return new Date(a.birthDate) - new Date(b.birthDate);
                    });
                }
                
                // Apply search filter
                if (searchQuery.trim()) {
                    filtered = filtered.filter(client => 
                        client.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        client.phone.includes(searchQuery)
                    );
                }
                
                return filtered;
            };
            
            const filteredClients = getFilteredClients();
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21]">
                    {/* Header with logo */}
                    <div class="flex items-center gap-3 p-4 justify-between border-b border-white/5">
                        <img src="./Images/hor-barber-logo.png" alt="HOR. Barber" class="h-10 scale-125" />
                        <h2 class="text-white text-lg font-bold flex-1 text-center">Clients</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    {/* Search Bar */}
                    <div class="px-4 pt-4">
                        <div class="relative">
                            <input 
                                type="text"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                placeholder="Search clients..."
                                class="w-full h-12 pl-12 pr-4 rounded-xl bg-[#2A2D31] text-white placeholder-slate-500 border-none focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                            />
                            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">search</span>
                        </div>
                    </div>
                    
                    {/* Filter Tabs */}
                    <div class="px-4 pt-4 flex gap-2">
                        <button 
                            onClick={() => setFilterType('all')}
                            class={`flex-1 py-3 px-4 rounded-xl font-semibold transition-all ${filterType === 'all' ? 'bg-[#FA383E] text-white' : 'bg-[#2A2D31] text-slate-400'}`}
                        >
                            All Clients
                        </button>
                        <button 
                            onClick={() => setFilterType('recent')}
                            class={`flex-1 py-3 px-4 rounded-xl font-semibold transition-all ${filterType === 'recent' ? 'bg-[#FA383E] text-white' : 'bg-[#2A2D31] text-slate-400'}`}
                        >
                            Recent (10d)
                        </button>
                    </div>
                    
                    {/* Clients List */}
                    <div class="flex-1 p-4 pb-24 space-y-3">
                        {filteredClients.length === 0 ? (
                            <div class="text-center py-12">
                                <span class="material-symbols-outlined text-slate-600 text-5xl mb-3 block">person_search</span>
                                <p class="text-slate-500 text-lg">No clients found</p>
                            </div>
                        ) : (
                            filteredClients.map((client) => {
                                const level = getClientLevel(client.visits || 0);
                                return (
                                <div key={client.id} class="bg-[#2A2D31] rounded-xl p-4 border border-white/5 relative">
                                    <div onClick={() => navigate('client-profile', client)} class="cursor-pointer hover:bg-[#35383D]/50 transition-colors rounded-lg -m-4 p-4">
                                        <div class="flex items-center gap-3">
                                            <div class="relative shrink-0">
                                                {client.image ? (
                                                    <div class="h-12 w-12 rounded-full bg-cover bg-center" style={{backgroundImage: `url("${client.image}")`}}></div>
                                                ) : (
                                                    <div class="h-12 w-12 rounded-full bg-[#2A2D31] border-2 border-[#FA383E] flex items-center justify-center text-[#FA383E] font-bold">
                                                        {client.name.charAt(0)}
                                                    </div>
                                                )}
                                                {level && (
                                                    <div class="absolute -bottom-1 -right-1 rounded-full p-0.5 border-2 border-[#1C1E21]" style={{backgroundColor: level.bgColor}} title={`${level.name} Member`}>
                                                        <span class="material-symbols-outlined text-white" style={{fontSize: '12px'}}>{level.icon}</span>
                                                    </div>
                                                )}
                                            </div>
                                            <div class="flex-1">
                                                <p class="text-white font-bold text-lg">{client.name}</p>
                                                <p class="text-slate-400 text-sm mt-1">{client.phone}</p>
                                                {client.preferredBarber && (
                                                    <p class="text-[#F35369] text-xs mt-1">Barber: {client.preferredBarber}</p>
                                                )}
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-4 mt-3 pt-3 border-t border-white/5">
                                            <div class="flex items-center gap-1 text-slate-400 text-sm">
                                                <span class="material-symbols-outlined text-sm">content_cut</span>
                                                <span>{client.visits} visits</span>
                                            </div>
                                            {client.lastVisit && (
                                                <div class="flex items-center gap-1 text-slate-400 text-sm">
                                                    <span class="material-symbols-outlined text-sm">schedule</span>
                                                    <span>Last: {new Date(client.lastVisit).toLocaleDateString()}</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <button 
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            deleteClient(client.id);
                                        }}
                                        class="absolute top-3 right-3 p-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 transition-colors group"
                                        title="Delete client"
                                    >
                                        <span class="material-symbols-outlined text-red-500 text-sm group-hover:scale-110 transition-transform">delete</span>
                                    </button>
                                </div>
                                );
                            })
                        )}
                    </div>
                    
                    {/* FAB */}
                    <button onClick={() => navigate('register-client')} class="fixed bottom-20 right-6 z-40 flex items-center justify-center w-16 h-16 rounded-full bg-[#FA383E] shadow-lg shadow-[#FA383E]/30 active:scale-95 transition-transform">
                        <span class="material-symbols-outlined text-white text-3xl font-bold">person_add</span>
                    </button>
                    
                    {/* Bottom Nav */}
                    <div class="fixed bottom-0 left-0 right-0 z-50 bg-[#1C1E21] border-t border-white/5">
                        <div class="flex items-center justify-around h-16">
                            <button onClick={() => navigate('dashboard')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">dashboard</span>
                                <span class="text-[10px] font-medium">Home</span>
                            </button>
                            <button onClick={() => navigate('clients-list')} class="flex flex-col items-center justify-center gap-1 p-2 text-[#FA383E]">
                                <span class="material-symbols-outlined">people</span>
                                <span class="text-[10px] font-medium">Clients</span>
                            </button>
                            <button onClick={() => navigate('analytics')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">bar_chart</span>
                                <span class="text-[10px] font-medium">Analytics</span>
                            </button>
                            <button onClick={() => navigate('settings')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">settings</span>
                                <span class="text-[10px] font-medium">Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Placeholder components for other screens
        function ManageBarbers({ navigate, data, showToast }) {
            const { barbers = [], setBarbers = () => {} } = data || {};
            const [barberList, setBarberList] = React.useState(() => {
                // Convert old string array to object array if needed
                if (barbers.length > 0 && typeof barbers[0] === 'string') {
                    return barbers.map(name => ({
                        name,
                        phone: '',
                        email: '',
                        schedule: { monday: '9:00 AM - 7:00 PM', tuesday: '9:00 AM - 7:00 PM', wednesday: '9:00 AM - 7:00 PM', thursday: '9:00 AM - 7:00 PM', friday: '9:00 AM - 7:00 PM', saturday: '9:00 AM - 5:00 PM', sunday: 'Closed' }
                    }));
                }
                return barbers;
            });
            const [newBarberName, setNewBarberName] = React.useState('');
            const [newBarberPhone, setNewBarberPhone] = React.useState('');
            const [newBarberEmail, setNewBarberEmail] = React.useState('');
            const [showAddForm, setShowAddForm] = React.useState(false);
            const [confirmDelete, setConfirmDelete] = React.useState(null);
            
            React.useEffect(() => {
                // Convert and normalize barbers array
                if (Array.isArray(barbers)) {
                    const normalized = barbers.map(barber => {
                        if (typeof barber === 'string') {
                            return {
                                name: barber,
                                phone: '',
                                email: '',
                                schedule: { monday: '9:00 AM - 7:00 PM', tuesday: '9:00 AM - 7:00 PM', wednesday: '9:00 AM - 7:00 PM', thursday: '9:00 AM - 7:00 PM', friday: '9:00 AM - 7:00 PM', saturday: '9:00 AM - 5:00 PM', sunday: 'Closed' }
                            };
                        }
                        return barber;
                    }).filter(Boolean); // Remove null/undefined values
                    setBarberList(normalized);
                } else {
                    setBarberList([]);
                }
            }, [barbers]);
            
            const handleAddBarber = async () => {
                if (!newBarberName.trim()) {
                    showToast ? showToast('âš ï¸ Please enter a barber name', 'warning') : alert('âš ï¸ Please enter a barber name');
                    return;
                }
                const newBarber = {
                    name: newBarberName.trim(),
                    phone: newBarberPhone.trim(),
                    email: newBarberEmail.trim(),
                    schedule: { 
                        monday: '9:00 AM - 7:00 PM', 
                        tuesday: '9:00 AM - 7:00 PM', 
                        wednesday: '9:00 AM - 7:00 PM', 
                        thursday: '9:00 AM - 7:00 PM', 
                        friday: '9:00 AM - 7:00 PM', 
                        saturday: '9:00 AM - 5:00 PM', 
                        sunday: 'Closed' 
                    }
                };
                const updated = [...barberList, newBarber];
                setBarberList(updated);
                // Save directly to storage first (Settings component unmounts on navigation)
                await FirebaseService.saveSetting('barbers', JSON.stringify(updated));
                console.log('âœ… Directly saved barbers in ManageBarbers');
                
                // Update navigation state as fallback
                setBarbers(updated);
                
                setNewBarberName('');
                setNewBarberPhone('');
                setNewBarberEmail('');
                setShowAddForm(false);
                showToast ? showToast(`âœ… ${newBarberName.trim()} added successfully!`) : alert(`âœ… ${newBarberName.trim()} added successfully!`);
            };
            
            const promptDeleteBarber = (barberName) => {
                if (barberList.length <= 1) {
                    showToast ? showToast('You must have at least one barber', 'warning') : alert('You must have at least one barber');
                    return;
                }
                setConfirmDelete(barberName);
            };

            const confirmDeleteBarber = async () => {
                if (!confirmDelete) return;

                const updated = barberList.filter(b => {
                    const bName = typeof b === 'string' ? b : b.name;
                    return bName !== confirmDelete;
                });

                setBarberList(updated);
                // Save directly to storage
                await FirebaseService.saveSetting('barbers', JSON.stringify(updated));
                console.log('âœ… Directly saved deleted barber in ManageBarbers');
                setBarbers(updated);
                setConfirmDelete(null);
                showToast ? showToast('âœ… Barber removed successfully!') : alert('âœ… Barber removed successfully!');
            };
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21]">
                    <div class="flex items-center gap-3 p-4 justify-between border-b border-white/5">
                        <button onClick={() => navigate('settings')} class="text-white flex items-center justify-center rounded-full hover:bg-white/10 transition-colors p-2">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h2 class="text-white text-lg font-bold flex-1 text-center">Manage Barbers</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    <div class="flex-1 p-4 pb-24">
                        <div class="space-y-3">
                            {barberList.map((barber, index) => {
                                // Ensure barber is valid
                                if (!barber) return null;
                                
                                const barberName = typeof barber === 'string' ? barber : (barber?.name || 'Unknown');
                                const barberPhone = typeof barber === 'object' ? barber?.phone : '';
                                const barberEmail = typeof barber === 'object' ? barber?.email : '';
                                const barberObj = typeof barber === 'string' ? { name: barber, phone: '', email: '', schedule: {} } : barber;
                                
                                // Ensure barberName is a string
                                const nameStr = String(barberName);
                                
                                return (
                                    <div key={index} class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center gap-3">
                                                <div class="w-12 h-12 rounded-full bg-[#FA383E] flex items-center justify-center text-white font-bold text-lg">
                                                    {nameStr.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <p class="text-white font-semibold">{nameStr}</p>
                                                    <p class="text-slate-400 text-sm">Barber</p>
                                                </div>
                                            </div>
                                            <div class="flex gap-2">
                                                <button 
                                                    onClick={() => navigate('edit-barber', { barber: barberObj, barberList, setBarbers })}
                                                    class="p-2 rounded-lg bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/30 transition-colors"
                                                >
                                                    <span class="material-symbols-outlined text-blue-500 text-sm">edit</span>
                                                </button>
                                                <button 
                                                    onClick={() => promptDeleteBarber(nameStr)}
                                                    class="p-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 transition-colors"
                                                >
                                                    <span class="material-symbols-outlined text-red-500 text-sm">delete</span>
                                                </button>
                                            </div>
                                        </div>
                                        {(barberPhone || barberEmail) && (
                                            <div class="mt-3 pt-3 border-t border-white/5 space-y-1">
                                                {barberPhone && (
                                                    <div class="flex items-center gap-2 text-sm">
                                                        <span class="material-symbols-outlined text-slate-500 text-sm">phone</span>
                                                        <span class="text-slate-300">{barberPhone}</span>
                                                    </div>
                                                )}
                                                {barberEmail && (
                                                    <div class="flex items-center gap-2 text-sm">
                                                        <span class="material-symbols-outlined text-slate-500 text-sm">email</span>
                                                        <span class="text-slate-300">{barberEmail}</span>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        
                        {showAddForm && (
                            <div class="mt-4 bg-[#2A2D31] rounded-xl p-4 border border-white/5 space-y-3">
                                <input 
                                    type="text"
                                    value={newBarberName}
                                    onChange={(e) => setNewBarberName(e.target.value)}
                                    placeholder="Barber name *"
                                    class="w-full h-12 rounded-lg border-none bg-[#35383D] px-4 text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                                />
                                <input 
                                    type="tel"
                                    value={newBarberPhone}
                                    onChange={(e) => setNewBarberPhone(e.target.value)}
                                    placeholder="Phone"
                                    class="w-full h-12 rounded-lg border-none bg-[#35383D] px-4 text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                                />
                                <input 
                                    type="email"
                                    value={newBarberEmail}
                                    onChange={(e) => setNewBarberEmail(e.target.value)}
                                    placeholder="Email"
                                    class="w-full h-12 rounded-lg border-none bg-[#35383D] px-4 text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                                />
                                <div class="flex gap-2">
                                    <button 
                                        onClick={handleAddBarber}
                                        class="flex-1 h-10 bg-[#FA383E] rounded-lg text-white font-semibold hover:bg-[#F35369]"
                                    >
                                        Add
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setShowAddForm(false);
                                            setNewBarberName('');
                                            setNewBarberPhone('');
                                            setNewBarberEmail('');
                                        }}
                                        class="flex-1 h-10 bg-[#35383D] rounded-lg text-white font-semibold hover:bg-[#3A3D42]"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        {/* Delete Confirm Modal */}
                        {confirmDelete && (
                            <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                                <div class="bg-[#2A2D31] rounded-2xl p-6 max-w-sm w-full border border-white/10 shadow-2xl">
                                    <div class="flex items-center justify-center w-16 h-16 rounded-full bg-red-500/20 border-2 border-red-500/50 mx-auto mb-4">
                                        <span class="material-symbols-outlined text-red-500 text-3xl">delete</span>
                                    </div>
                                    <h3 class="text-white text-xl font-bold text-center mb-2">Delete Barber?</h3>
                                    <p class="text-slate-400 text-center mb-4">Are you sure you want to delete <span class="text-white font-bold">{confirmDelete}</span>?</p>
                                    <div class="flex gap-3">
                                        <button 
                                            onClick={() => setConfirmDelete(null)}
                                            class="flex-1 px-4 py-3 bg-[#35383D] border border-white/10 rounded-xl text-white font-bold hover:bg-[#3A3D42] transition-colors"
                                        >
                                            Cancel
                                        </button>
                                        <button 
                                            onClick={confirmDeleteBarber}
                                            class="flex-1 px-4 py-3 bg-red-500 rounded-xl text-white font-bold hover:bg-red-600 transition-colors"
                                        >
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 z-20 bg-[#1C1E21] p-6 border-t border-white/5">
                        <button 
                            onClick={() => setShowAddForm(true)}
                            class="w-full h-14 bg-[#FA383E] rounded-xl text-white font-bold hover:bg-[#F35369] active:scale-[0.98] transition-all flex items-center justify-center gap-2"
                        >
                            <span class="material-symbols-outlined">add</span>
                            <span>Add New Barber</span>
                        </button>
                    </div>
                </div>
            );
        }
        
        function BusinessInfo({ navigate, data, showToast }) {
            const { businessInfo = {}, setBusinessInfo = () => {} } = data || {};
            const [formData, setFormData] = React.useState(businessInfo);
            
            const handleSave = async () => {
                // Save directly to storage
                await FirebaseService.saveSetting('business_info', JSON.stringify(formData));
                console.log('âœ… Directly saved business info');
                
                setBusinessInfo(formData);
                showToast ? showToast('âœ… Business Info updated successfully!') : alert('âœ… Business Info updated successfully!');
                navigate('settings');
            };
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21]">
                    <div class="flex items-center gap-3 p-4 justify-between border-b border-white/5">
                        <button onClick={() => navigate('settings')} class="text-white flex items-center justify-center rounded-full hover:bg-white/10 transition-colors p-2">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h2 class="text-white text-lg font-bold flex-1 text-center">Business Info</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    <div class="flex-1 p-6 pb-24 space-y-4">
                        <div>
                            <label class="text-slate-400 text-sm mb-2 block">Business Name</label>
                            <input 
                                type="text"
                                value={formData.name || ''}
                                onChange={(e) => setFormData({...formData, name: e.target.value})}
                                class="w-full h-12 rounded-xl border-none bg-[#2A2D31] px-4 text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                            />
                        </div>
                        
                        <div>
                            <label class="text-slate-400 text-sm mb-2 block">Phone</label>
                            <input 
                                type="tel"
                                value={formData.phone || ''}
                                onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                class="w-full h-12 rounded-xl border-none bg-[#2A2D31] px-4 text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                            />
                        </div>
                        
                        <div>
                            <label class="text-slate-400 text-sm mb-2 block">Email</label>
                            <input 
                                type="email"
                                value={formData.email || ''}
                                onChange={(e) => setFormData({...formData, email: e.target.value})}
                                class="w-full h-12 rounded-xl border-none bg-[#2A2D31] px-4 text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                            />
                        </div>
                        
                        <div>
                            <label class="text-slate-400 text-sm mb-2 block">Address</label>
                            <textarea 
                                value={formData.address || ''}
                                onChange={(e) => setFormData({...formData, address: e.target.value})}
                                class="w-full h-24 rounded-xl border-none bg-[#2A2D31] px-4 py-3 text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none resize-none"
                            />
                        </div>
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 z-20 bg-[#1C1E21] p-6 border-t border-white/5">
                        <button 
                            onClick={handleSave}
                            class="w-full h-14 bg-[#FA383E] rounded-xl text-white font-bold hover:bg-[#F35369] active:scale-[0.98] transition-all"
                        >
                            Save Changes
                        </button>
                    </div>
                </div>
            );
        }

        function ServicePrices({ navigate, data, showToast }) {
            const { servicePrices = {}, setServicePrices = () => {} } = data || {};
            const [editableServices, setEditableServices] = React.useState([]);
            
            React.useEffect(() => {
                // Load services definitions from localStorage
                let servicesList;
                try {
                    const local = localStorage.getItem('barberapp_services');
                    servicesList = local ? JSON.parse(local) : [
                        {id: 'fade', name: 'Fade', icon: 'content_cut'},
                        {id: 'beard', name: 'Beard', icon: 'face'},
                        {id: 'fullcut', name: 'Full Cut', icon: 'cut'},
                        {id: 'scissors', name: 'Scissors', icon: 'content_cut'},
                    ];
                } catch(e) {
                    console.error('Error loading services:', e);
                    servicesList = [
                        {id: 'fade', name: 'Fade', icon: 'content_cut'},
                        {id: 'beard', name: 'Beard', icon: 'face'},
                        {id: 'fullcut', name: 'Full Cut', icon: 'cut'},
                        {id: 'scissors', name: 'Scissors', icon: 'content_cut'},
                    ];
                }

                // Map to editable structure
                const mapped = servicesList.map(s => ({
                    ...s,
                    // Try to match by name, otherwise default to 0
                    price: servicePrices[s.name] || 0
                }));
                setEditableServices(mapped);
            }, [servicePrices]);
            
            const handleSave = async () => {
                // 1. Save definitions (Names updated)
                const definitions = editableServices.map(({id, name, icon}) => ({id, name, icon}));
                localStorage.setItem('barberapp_services', JSON.stringify(definitions));
                
                // 2. Save Prices (Mapped by Name)
                const newPrices = {};
                editableServices.forEach(s => {
                    newPrices[s.name] = parseFloat(s.price) || 0;
                });
                
                // Save directly to storage
                await FirebaseService.saveSetting('service_prices', JSON.stringify(newPrices));
                console.log('âœ… Directly saved service prices');
                
                setServicePrices(newPrices);
                showToast ? showToast('âœ… Services updated successfully!') : alert('âœ… Services updated successfully!');
                navigate('settings');
            };
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21]">
                    <div class="flex items-center gap-3 p-4 justify-between border-b border-white/5">
                        <button onClick={() => navigate('settings')} class="text-white flex items-center justify-center rounded-full hover:bg-white/10 transition-colors p-2">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h2 class="text-white text-lg font-bold flex-1 text-center">Manage Services</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    <div class="flex-1 p-6 pb-24 space-y-4">
                        {editableServices.map((service, index) => (
                            <div key={service.id} class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                                <div class="flex flex-col gap-3">
                                    {/* Name Edit */}
                                    <div>
                                        <label class="text-slate-400 text-xs uppercase tracking-wider font-bold mb-1.5 block">Service Name</label>
                                        <div class="flex items-center gap-2">
                                            <span class="material-symbols-outlined text-slate-500">{service.icon}</span>
                                            <input 
                                                type="text"
                                                value={service.name}
                                                onChange={(e) => {
                                                    const newValue = e.target.value;
                                                    setEditableServices(prev => prev.map((s, i) => i === index ? {...s, name: newValue} : s));
                                                }}
                                                class="flex-1 h-10 rounded-lg border border-white/10 bg-[#35383D] px-3 text-white text-base font-medium focus:ring-2 focus:ring-[#FA383E] focus:outline-none placeholder:text-slate-600"
                                                placeholder="Service Name"
                                            />
                                        </div>
                                    </div>
                                    
                                    {/* Price Edit */}
                                    <div>
                                        <label class="text-slate-400 text-xs uppercase tracking-wider font-bold mb-1.5 block">Price</label>
                                        <div class="flex items-center gap-3">
                                            <span class="text-slate-400 text-xl font-bold">$</span>
                                            <input 
                                                type="number"
                                                value={service.price}
                                                onChange={(e) => {
                                                    const newValue = e.target.value;
                                                    setEditableServices(prev => prev.map((s, i) => i === index ? {...s, price: newValue} : s));
                                                }}
                                                class="flex-1 h-10 rounded-lg border-none bg-[#35383D] px-3 text-white text-lg font-bold focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 z-20 bg-[#1C1E21] p-6 border-t border-white/5">
                        <button 
                            onClick={handleSave}
                            class="w-full h-14 bg-[#FA383E] rounded-xl text-white font-bold hover:bg-[#F35369] active:scale-[0.98] transition-all flex items-center justify-center gap-2"
                        >
                            <span class="material-symbols-outlined">save</span>
                            Save Changes
                        </button>
                    </div>
                </div>
            );
        }

        function EditBarber({ navigate, data, showToast }) {
            const { barber = {}, barberList = [], setBarbers = () => {} } = data || {};
            const [formData, setFormData] = React.useState(barber);
            
            React.useEffect(() => {
                setFormData(barber);
            }, [barber]);
            
            const handleSave = async () => {
                const updated = barberList.map(b => {
                    const bName = typeof b === 'string' ? b : b.name;
                    const barberName = typeof barber === 'string' ? barber : barber.name;
                    return bName === barberName ? formData : b;
                });
                
                // Save directly to storage
                await FirebaseService.saveSetting('barbers', JSON.stringify(updated));
                console.log('âœ… Directly saved updated barber');
                
                setBarbers(updated);
                showToast ? showToast('âœ… Barber updated successfully!') : alert('âœ… Barber updated successfully!');
                navigate('manage-barbers', { barbers: updated, setBarbers });
            };
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21]">
                    <div class="flex items-center gap-3 p-4 justify-between border-b border-white/5">
                        <button onClick={() => navigate('manage-barbers', { barbers: barberList, setBarbers })} class="text-white flex items-center justify-center rounded-full hover:bg-white/10 transition-colors p-2">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h2 class="text-white text-lg font-bold flex-1 text-center">Edit Barber</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    <div class="flex-1 p-6 pb-24 space-y-4">
                        <div>
                            <label class="text-slate-400 text-sm mb-2 block">Name</label>
                            <input 
                                type="text"
                                value={formData.name || ''}
                                onChange={(e) => setFormData({...formData, name: e.target.value})}
                                class="w-full h-12 rounded-xl border-none bg-[#2A2D31] px-4 text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                            />
                        </div>
                        
                        <div>
                            <label class="text-slate-400 text-sm mb-2 block">Phone</label>
                            <input 
                                type="tel"
                                value={formData.phone || ''}
                                onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                class="w-full h-12 rounded-xl border-none bg-[#2A2D31] px-4 text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                            />
                        </div>
                        
                        <div>
                            <label class="text-slate-400 text-sm mb-2 block">Email</label>
                            <input 
                                type="email"
                                value={formData.email || ''}
                                onChange={(e) => setFormData({...formData, email: e.target.value})}
                                class="w-full h-12 rounded-xl border-none bg-[#2A2D31] px-4 text-white focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                            />
                        </div>
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 z-20 bg-[#1C1E21] p-6 border-t border-white/5">
                        <button 
                            onClick={handleSave}
                            class="w-full h-14 bg-[#FA383E] rounded-xl text-white font-bold hover:bg-[#F35369] active:scale-[0.98] transition-all"
                        >
                            Save Changes
                        </button>
                    </div>
                </div>
            );
        }

        function BarberSchedules({ navigate, data, showToast }) {
            const { barbers = [], setBarbers = () => {} } = data || {};
            const [barberList, setBarberList] = React.useState(barbers);
            const [selectedBarber, setSelectedBarber] = React.useState(null);
            
            React.useEffect(() => {
                setBarberList(barbers);
            }, [barbers]);
            
            const days = [
                { key: 'monday', label: 'Monday', abbr: 'M' },
                { key: 'tuesday', label: 'Tuesday', abbr: 'T' },
                { key: 'wednesday', label: 'Wednesday', abbr: 'W' },
                { key: 'thursday', label: 'Thursday', abbr: 'T' },
                { key: 'friday', label: 'Friday', abbr: 'F' },
                { key: 'saturday', label: 'Saturday', abbr: 'S' },
                { key: 'sunday', label: 'Sunday', abbr: 'S' }
            ];
            
            const timeOptions = React.useMemo(() => {
                const options = [];
                for (let i = 0; i < 24; i++) {
                    for (let j = 0; j < 60; j += 30) {
                        const hour = i.toString().padStart(2, '0');
                        const minute = j.toString().padStart(2, '0');
                        const time = `${hour}:${minute}`;
                        
                        const period = i >= 12 ? 'PM' : 'AM';
                        const displayHour = i === 0 ? 12 : i > 12 ? i - 12 : i;
                        const label = `${displayHour}:${minute} ${period}`;
                        
                        options.push({ value: time, label });
                    }
                }
                return options;
            }, []);
            
            const parseDaySchedule = (schedule) => {
                if (!schedule) return { enabled: false, start: '09:00', end: '17:00' };
                if (schedule.toLowerCase() === 'closed' || schedule.toLowerCase() === 'off') {
                    return { enabled: false, start: '09:00', end: '17:00' };
                }
                const match = schedule.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?\s*-\s*(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                if (match) {
                    let startHour = parseInt(match[1]);
                    const startMin = match[2];
                    const startPeriod = match[3];
                    let endHour = parseInt(match[4]);
                    const endMin = match[5];
                    const endPeriod = match[6];
                    
                    if (startPeriod && startPeriod.toUpperCase() === 'PM' && startHour !== 12) startHour += 12;
                    if (startPeriod && startPeriod.toUpperCase() === 'AM' && startHour === 12) startHour = 0;
                    if (endPeriod && endPeriod.toUpperCase() === 'PM' && endHour !== 12) endHour += 12;
                    if (endPeriod && endPeriod.toUpperCase() === 'AM' && endHour === 12) endHour = 0;
                    
                    return {
                        enabled: true,
                        start: `${String(startHour).padStart(2, '0')}:${startMin}`,
                        end: `${String(endHour).padStart(2, '0')}:${endMin}`
                    };
                }
                return { enabled: true, start: '09:00', end: '17:00' };
            };
            
            const formatTimeToDisplay = (time24) => {
                const [hours, minutes] = time24.split(':');
                const hour = parseInt(hours);
                const period = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                return `${displayHour}:${minutes} ${period}`;
            };
            
            const handleToggleDay = (day, currentValue) => {
                if (!selectedBarber) return;
                const schedule = selectedBarber.schedule || {};
                const newSchedule = {
                    ...schedule,
                    [day]: currentValue.enabled ? 'Closed' : '9:00 AM - 5:00 PM'
                };
                setSelectedBarber({ ...selectedBarber, schedule: newSchedule });
            };
            
            const handleTimeChange = (day, type, value) => {
                if (!selectedBarber) return;
                const schedule = selectedBarber.schedule || {};
                const current = parseDaySchedule(schedule[day]);
                const newStart = type === 'start' ? value : current.start;
                const newEnd = type === 'end' ? value : current.end;
                const formatted = `${formatTimeToDisplay(newStart)} - ${formatTimeToDisplay(newEnd)}`;
                setSelectedBarber({
                    ...selectedBarber,
                    schedule: { ...schedule, [day]: formatted }
                });
            };
            
            const handleSave = async () => {
                const updated = barberList.map(b => 
                    (typeof b === 'string' ? b : b.name) === (typeof selectedBarber === 'string' ? selectedBarber : selectedBarber.name) 
                        ? selectedBarber 
                        : b
                );
                setBarberList(updated);
                
                // Save directly to storage
                await FirebaseService.saveSetting('barbers', JSON.stringify(updated));
                console.log('âœ… Directly saved barber schedule');
                
                setBarbers(updated);
                showToast ? showToast('âœ… Schedule updated successfully!') : alert('âœ… Schedule updated successfully!');
                setSelectedBarber(null);
            };
            
            const getActiveDaysCount = () => {
                if (!selectedBarber || !selectedBarber.schedule) return 0;
                return Object.values(selectedBarber.schedule).filter(s => 
                    s && s.toLowerCase() !== 'closed' && s.toLowerCase() !== 'off'
                ).length;
            };
            
            if (selectedBarber) {
                const barberName = typeof selectedBarber === 'string' ? selectedBarber : (selectedBarber.name || 'Barber');
                const activeDays = getActiveDaysCount();
                const offDays = 7 - activeDays;
                
                return (
                    <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21]">
                        <div class="sticky top-0 z-20 flex items-center bg-[#1C1E21]/90 backdrop-blur-md p-4 pb-2 justify-between border-b border-white/5">
                            <button onClick={() => setSelectedBarber(null)} class="text-white flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-white/10 transition-colors">
                                <span class="material-symbols-outlined">arrow_back</span>
                            </button>
                            <div class="flex flex-col items-center flex-1">
                                <h2 class="text-white text-lg font-bold leading-tight tracking-tight">Edit Schedule</h2>
                                <span class="text-xs text-[#FA383E] font-medium">{barberName}</span>
                            </div>
                            <div class="flex w-10 items-center justify-end">
                                <div class="h-10 w-10 rounded-full bg-gradient-to-br from-[#FA383E] to-orange-500 flex items-center justify-center text-white font-bold text-lg">
                                    {barberName.charAt(0).toUpperCase()}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto no-scrollbar pb-32">
                            <div class="p-6">
                                <div class="mb-6">
                                    <h3 class="text-white text-xl font-bold">Weekly Availability</h3>
                                    <p class="text-sm text-slate-400 mt-1">Configure working hours for the week. Changes apply immediately.</p>
                                </div>
                                
                                <div class="space-y-4">
                                    {days.map(day => {
                                        const daySchedule = parseDaySchedule(selectedBarber.schedule?.[day.key]);
                                        const isEnabled = daySchedule.enabled;
                                        
                                        return (
                                            <div key={day.key} class={`relative overflow-hidden rounded-2xl border p-5 transition-all ${
                                                isEnabled 
                                                    ? 'bg-[#2A2D31] border-white/10' 
                                                    : 'bg-[#2A2D31]/50 border-white/5 opacity-80 hover:opacity-100'
                                            }`}>
                                                <div class="flex items-center justify-between mb-4">
                                                    <div class="flex items-center gap-3">
                                                        <div class={`flex h-8 w-8 items-center justify-center rounded-full ${
                                                            isEnabled ? 'bg-[#FA383E]/20 text-[#FA383E]' : 'bg-white/5 text-slate-400'
                                                        }`}>
                                                            <span class="text-xs font-bold">{day.abbr}</span>
                                                        </div>
                                                        <span class={`text-base font-bold ${
                                                            isEnabled ? 'text-white' : 'text-slate-400 font-medium'
                                                        }`}>{day.label}</span>
                                                    </div>
                                                    <label class="relative inline-block w-12 align-middle select-none">
                                                        <input 
                                                            type="checkbox"
                                                            checked={isEnabled}
                                                            onChange={() => handleToggleDay(day.key, daySchedule)}
                                                            class="sr-only"
                                                        />
                                                        <div class={`block h-6 rounded-full transition-colors cursor-pointer ${
                                                            isEnabled ? 'bg-[#FA383E]' : 'bg-slate-700'
                                                        }`}>
                                                            <div class={`absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-[#1C1E21] border-2 transition-transform ${
                                                                isEnabled ? 'transform translate-x-6 border-[#FA383E]' : 'border-slate-600'
                                                            }`}></div>
                                                        </div>
                                                    </label>
                                                </div>
                                                
                                                {isEnabled ? (
                                                    <div class="grid grid-cols-[1fr,auto,1fr] gap-3 items-center">
                                                        <div class="relative group">
                                                            <label class="block text-[10px] uppercase tracking-wider text-slate-500 mb-1.5 font-semibold">Start Time</label>
                                                            <div class="relative flex items-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl px-3 py-3 transition-colors">
                                                                <span class="material-symbols-outlined text-[#FA383E] text-xl mr-3">schedule</span>
                                                                <div class="relative flex-1 min-w-0">
                                                                    <select 
                                                                        value={daySchedule.start}
                                                                        onChange={(e) => handleTimeChange(day.key, 'start', e.target.value)}
                                                                        class="bg-transparent bg-none border-none p-0 text-base font-bold text-white focus:ring-0 w-full font-mono appearance-none cursor-pointer pr-5"
                                                                    >
                                                                        {timeOptions.map(option => (
                                                                            <option key={option.value} value={option.value} class="text-black bg-white">
                                                                                {option.label}
                                                                            </option>
                                                                        ))}
                                                                    </select>
                                                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pl-2">
                                                                        <span class="material-symbols-outlined text-sm text-slate-400">expand_more</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="pt-5 text-slate-600">
                                                            <span class="material-symbols-outlined">arrow_forward</span>
                                                        </div>
                                                        <div class="relative group">
                                                            <label class="block text-[10px] uppercase tracking-wider text-slate-500 mb-1.5 font-semibold">End Time</label>
                                                            <div class="relative flex items-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl px-3 py-3 transition-colors">
                                                                <span class="material-symbols-outlined text-slate-400 text-xl mr-3">schedule</span>
                                                                <div class="relative flex-1 min-w-0">
                                                                    <select 
                                                                        value={daySchedule.end}
                                                                        onChange={(e) => handleTimeChange(day.key, 'end', e.target.value)}
                                                                        class="bg-transparent bg-none border-none p-0 text-base font-bold text-white focus:ring-0 w-full font-mono appearance-none cursor-pointer pr-5"
                                                                    >
                                                                        {timeOptions.map(option => (
                                                                            <option key={option.value} value={option.value} class="text-black bg-white">
                                                                                {option.label}
                                                                            </option>
                                                                        ))}
                                                                    </select>
                                                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pl-2">
                                                                        <span class="material-symbols-outlined text-sm text-slate-400">expand_more</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div class="mt-2 text-xs text-slate-600 italic">Marked as Day Off</div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                        
                        <div class="absolute bottom-0 z-30 w-full border-t border-white/10 bg-[#1C1E21]/95 backdrop-blur-xl p-4">
                            <div class="flex items-center justify-between text-xs text-slate-400 mb-3 px-1">
                                <span class="flex items-center gap-1">
                                    <span class="block size-2 rounded-full bg-[#FA383E]"></span> {activeDays} Active Days
                                </span>
                                <span class="flex items-center gap-1">
                                    <span class="block size-2 rounded-full bg-slate-600"></span> {offDays} Days Off
                                </span>
                            </div>
                            <button 
                                onClick={handleSave}
                                class="group relative w-full overflow-hidden rounded-xl bg-[#FA383E] px-4 py-4 text-center font-bold text-white transition-transform active:scale-[0.98] shadow-lg shadow-[#FA383E]/20"
                            >
                                <span class="relative z-10 flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined">save</span>
                                    Update Schedule
                                </span>
                                <div class="absolute inset-0 bg-white/20 opacity-0 transition-opacity group-hover:opacity-100"></div>
                            </button>
                        </div>
                    </div>
                );
            }
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21] pb-20">
                    <div class="flex items-center gap-3 p-4 justify-between border-b border-white/5">
                        <button onClick={() => navigate('settings')} class="text-white flex items-center justify-center rounded-full hover:bg-white/10 transition-colors p-2">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h2 class="text-white text-lg font-bold flex-1 text-center">Barber Schedules</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    <div class="flex-1 p-4 space-y-3">
                        {barberList.map((barber, index) => {
                            const barberName = typeof barber === 'string' ? barber : (barber.name || 'Barber');
                            return (
                                <button 
                                    key={index}
                                    onClick={() => setSelectedBarber(barber)}
                                    class="w-full bg-[#2A2D31] rounded-xl p-4 border border-white/5 flex items-center justify-between hover:bg-[#35383D] transition-colors"
                                >
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-full bg-[#FA383E] flex items-center justify-center text-white font-bold text-lg">
                                            {barberName.charAt(0).toUpperCase()}
                                        </div>
                                        <div class="text-left">
                                            <p class="text-white font-semibold">{barberName}</p>
                                            <p class="text-slate-400 text-sm">Configure schedule</p>
                                        </div>
                                    </div>
                                    <span class="material-symbols-outlined text-slate-500">chevron_right</span>
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        }
        
        function RewardRules({ navigate }) {
            const [rewardPrice, setRewardPrice] = React.useState(() => {
                const saved = localStorage.getItem('barberapp_reward_price');
                return saved ? parseFloat(saved) : 0;
            });
            
            const handleSave = () => {
                localStorage.setItem('barberapp_reward_price', rewardPrice.toString());
                navigate('settings');
            };
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21]">
                    <div class="flex items-center gap-3 p-4 justify-between border-b border-white/5">
                        <button onClick={() => navigate('settings')} class="text-white flex items-center justify-center rounded-full hover:bg-white/10 transition-colors p-2">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h2 class="text-white text-lg font-bold flex-1 text-center">Reward Rules</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    <div class="flex-1 p-6 pb-24">
                        <div class="bg-[#2A2D31] rounded-xl p-6 border border-white/5 mb-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-12 h-12 rounded-full bg-[#FA383E]/20 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[#FA383E] text-2xl">diamond</span>
                                </div>
                                <div>
                                    <p class="text-white font-bold text-lg">Loyalty Program</p>
                                    <p class="text-slate-400 text-sm">Every 10 visits = 1 free service</p>
                                </div>
                            </div>
                            <p class="text-slate-300 text-sm leading-relaxed">
                                When a client completes 10 visits, they automatically receive a free service voucher. Set the maximum value of the free service below.
                            </p>
                        </div>
                        
                        <div class="bg-[#2A2D31] rounded-xl p-6 border border-white/5">
                            <label class="text-white font-semibold mb-4 block">Free Service Value</label>
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-slate-400 text-2xl font-bold">$</span>
                                <input 
                                    type="number"
                                    value={rewardPrice}
                                    onChange={(e) => setRewardPrice(parseFloat(e.target.value) || 0)}
                                    class="flex-1 h-12 rounded-xl border-none bg-[#35383D] px-4 text-white text-xl font-bold focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                                    placeholder="0"
                                />
                            </div>
                            <p class="text-slate-400 text-xs mt-2">
                                This is the maximum value for the free service. Clients can choose any service up to this amount.
                            </p>
                        </div>
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 z-20 bg-[#1C1E21] p-6 border-t border-white/5">
                        <button 
                            onClick={handleSave}
                            class="w-full h-14 bg-[#FA383E] rounded-xl text-white font-bold hover:bg-[#F35369] active:scale-[0.98] transition-all"
                        >
                            Save Reward Rules
                        </button>
                    </div>
                </div>
            );
        }
        
        function Notifications({ navigate, clients }) {
            const today = new Date();
            const todayStr = `${today.getMonth() + 1}/${today.getDate()}`;
            
            const upcomingBirthdays = clients.filter(client => {
                if (!client.birthDate) return false;
                const bday = new Date(client.birthDate);
                const bdayStr = `${bday.getMonth() + 1}/${bday.getDate()}`;
                
                // Check if birthday is within next 7 days
                const daysUntil = [];
                for (let i = 0; i <= 7; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(today.getDate() + i);
                    daysUntil.push(`${checkDate.getMonth() + 1}/${checkDate.getDate()}`);
                }
                
                return daysUntil.includes(bdayStr);
            }).map(client => {
                const bday = new Date(client.birthDate);
                const bdayStr = `${bday.getMonth() + 1}/${bday.getDate()}`;
                const isToday = bdayStr === todayStr;
                return { ...client, isToday };
            });
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21] pb-20">
                    <div class="flex items-center gap-3 p-4 justify-between border-b border-white/5">
                        <button onClick={() => navigate('settings')} class="text-white flex items-center justify-center rounded-full hover:bg-white/10 transition-colors p-2">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h2 class="text-white text-lg font-bold flex-1 text-center">Notifications</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    <div class="flex-1 p-4">
                        <h3 class="text-white text-lg font-bold mb-4">Upcoming Birthdays</h3>
                        {upcomingBirthdays.length > 0 ? (
                            <div class="space-y-3">
                                {upcomingBirthdays.map(client => (
                                    <div key={client.id} class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                                        <div class="flex items-center gap-3">
                                            <div class="w-12 h-12 rounded-full bg-[#FA383E] flex items-center justify-center">
                                                <span class="material-symbols-outlined text-white text-2xl">cake</span>
                                            </div>
                                            <div class="flex-1">
                                                <p class="text-white font-semibold">{client.name}</p>
                                                <p class="text-slate-400 text-sm">
                                                    {client.isToday ? 'ðŸŽ‰ Birthday today!' : `Birthday on ${new Date(client.birthDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}`}
                                                </p>
                                                {client.phone && <p class="text-slate-500 text-xs mt-1">{client.phone}</p>}
                                            </div>
                                            {client.isToday && (
                                                <div class="px-3 py-1 bg-[#FA383E]/20 border border-[#FA383E]/30 rounded-full">
                                                    <span class="text-[#FA383E] text-xs font-bold">TODAY</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div class="bg-[#2A2D31] rounded-xl p-8 border border-white/5 text-center">
                                <span class="material-symbols-outlined text-slate-600 text-5xl mb-3 block">cake</span>
                                <p class="text-slate-400">No upcoming birthdays in the next 7 days</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        function VoucherHistory({ navigate }) {
            return <div class="flex h-screen w-full items-center justify-center bg-[#1C1E21] text-white"><button onClick={() => navigate('dashboard')} class="px-4 py-2 bg-[#FA383E] rounded-lg">Back to Dashboard</button></div>;
        }
        
        function BarberDetail({ navigate }) {
            return <div class="flex h-screen w-full items-center justify-center bg-[#1C1E21] text-white"><button onClick={() => navigate('dashboard')} class="px-4 py-2 bg-[#FA383E] rounded-lg">Back to Dashboard</button></div>;
        }
        
        function EditBarberSchedule({ navigate }) {
            return <div class="flex h-screen w-full items-center justify-center bg-[#1C1E21] text-white"><button onClick={() => navigate('dashboard')} class="px-4 py-2 bg-[#FA383E] rounded-lg">Back to Dashboard</button></div>;
        }
        
        function RecentActivity({ navigate, activities }) {
            const [barberFilter, setBarberFilter] = React.useState('all');
            const [periodFilter, setPeriodFilter] = React.useState('today');
            const [searchQuery, setSearchQuery] = React.useState('');
            const [customStartDate, setCustomStartDate] = React.useState('');
            const [customEndDate, setCustomEndDate] = React.useState('');
            
            const getFilteredActivities = () => {
                let filtered = [...activities];
                
                // Barber filter
                if (barberFilter !== 'all') {
                    filtered = filtered.filter(act => act.barber === barberFilter);
                }
                
                // Period filter
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                if (periodFilter === 'today') {
                    filtered = filtered.filter(act => {
                        const actDate = new Date(act.timestamp).toISOString().split('T')[0];
                        return actDate === todayStr;
                    });
                } else if (periodFilter === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    filtered = filtered.filter(act => new Date(act.timestamp) >= weekAgo);
                } else if (periodFilter === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    filtered = filtered.filter(act => new Date(act.timestamp) >= monthAgo);
                } else if (periodFilter === 'custom' && customStartDate && customEndDate) {
                    filtered = filtered.filter(act => {
                        const actDate = new Date(act.timestamp);
                        return actDate >= new Date(customStartDate) && actDate <= new Date(customEndDate);
                    });
                }
                
                // Search filter
                if (searchQuery.trim()) {
                    filtered = filtered.filter(act => 
                        act.clientName.toLowerCase().includes(searchQuery.toLowerCase())
                    );
                }
                
                return filtered;
            };
            
            const filteredActivities = getFilteredActivities();
            
            // Calculate stats
            const totalVisits = filteredActivities.length;
            
            return (
                <div class="relative flex h-full min-h-screen w-full flex-col bg-[#1C1E21]">
                    {/* Header with logo */}
                    <div class="flex items-center gap-3 p-4 justify-between border-b border-white/5">
                        <button onClick={() => navigate('dashboard')} class="text-white flex items-center justify-center rounded-full hover:bg-white/10 transition-colors p-2">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h2 class="text-white text-lg font-bold flex-1 text-center">Recent Activity</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    {/* Stats Cards */}
                    <div class="p-4 grid grid-cols-2 gap-3">
                        <div class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                            <p class="text-slate-400 text-sm mb-1">Total Visits</p>
                            <p class="text-white text-2xl font-bold">{totalVisits}</p>
                        </div>
                        <div class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                            <p class="text-slate-400 text-sm mb-1">Unique Clients</p>
                            <p class="text-[#FA383E] text-2xl font-bold">{new Set(filteredActivities.map(a => a.clientName)).size}</p>
                        </div>
                    </div>
                    
                    {/* Search Bar */}
                    <div class="px-4 pb-3">
                        <div class="relative">
                            <input 
                                type="text"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                placeholder="Search by client name..."
                                class="w-full h-12 pl-12 pr-4 rounded-xl bg-[#2A2D31] text-white placeholder-slate-500 border-none focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                            />
                            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">search</span>
                        </div>
                    </div>
                    
                    {/* Filters */}
                    <div class="px-4 space-y-3">
                        {/* Barber Filter */}
                        <div>
                            <label class="text-slate-400 text-sm mb-2 block">Barber</label>
                            <select 
                                value={barberFilter}
                                onChange={(e) => setBarberFilter(e.target.value)}
                                class="w-full h-12 px-4 rounded-xl bg-[#2A2D31] text-white border-none focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                            >
                                <option value="all">All Barbers</option>
                                <option value="Juan">Juan</option>
                                <option value="Nico">Nico</option>
                                <option value="Pedro">Pedro</option>
                            </select>
                        </div>
                        
                        {/* Period Filter */}
                        <div>
                            <label class="text-slate-400 text-sm mb-2 block">Period</label>
                            <select 
                                value={periodFilter}
                                onChange={(e) => setPeriodFilter(e.target.value)}
                                class="w-full h-12 px-4 rounded-xl bg-[#2A2D31] text-white border-none focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                            >
                                <option value="today">Today</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        
                        {/* Custom Date Range */}
                        {periodFilter === 'custom' && (
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-slate-400 text-xs mb-1 block">From</label>
                                    <input 
                                        type="date"
                                        value={customStartDate}
                                        onChange={(e) => setCustomStartDate(e.target.value)}
                                        class="w-full h-12 px-3 rounded-xl bg-[#2A2D31] text-white border-none focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                                    />
                                </div>
                                <div>
                                    <label class="text-slate-400 text-xs mb-1 block">To</label>
                                    <input 
                                        type="date"
                                        value={customEndDate}
                                        onChange={(e) => setCustomEndDate(e.target.value)}
                                        class="w-full h-12 px-3 rounded-xl bg-[#2A2D31] text-white border-none focus:ring-2 focus:ring-[#FA383E] focus:outline-none"
                                    />
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* Activity List */}
                    <div class="flex-1 p-4 pb-24 space-y-3 overflow-y-auto">
                        {filteredActivities.length === 0 ? (
                            <div class="text-center py-12">
                                <span class="material-symbols-outlined text-slate-600 text-5xl mb-3 block">event_busy</span>
                                <p class="text-slate-500 text-lg">No activity found</p>
                            </div>
                        ) : (
                            filteredActivities.map((activity) => {
                                const activityDate = new Date(activity.timestamp);
                                const timeStr = activityDate.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                                const dateStr = activityDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
                                const isToday = activityDate.toDateString() === new Date().toDateString();
                                
                                return (
                                    <div key={activity.id} class="bg-[#2A2D31] rounded-xl p-4 border border-white/5">
                                        <div class="flex items-start justify-between mb-2">
                                            <div class="flex-1">
                                                <p class="text-white font-bold text-lg">{activity.clientName}</p>
                                                {isToday && (
                                                    <span class="inline-block text-xs font-semibold text-green-500 bg-green-500/10 px-2 py-0.5 rounded-full mt-1">Today</span>
                                                )}
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 mb-2">
                                            <div class="bg-[#FA383E]/20 p-1.5 rounded">
                                                <span class="material-symbols-outlined text-[#FA383E] text-sm">content_cut</span>
                                            </div>
                                            <span class="text-slate-300 font-medium">{activity.service}</span>
                                            <span class="text-slate-600">â€¢</span>
                                            <span class="text-[#F35369] font-medium">{activity.barber}</span>
                                        </div>
                                        <div class="flex items-center gap-4 text-slate-500 text-xs">
                                            <div class="flex items-center gap-1">
                                                <span class="material-symbols-outlined text-sm">schedule</span>
                                                <span>{timeStr}</span>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <span class="material-symbols-outlined text-sm">calendar_today</span>
                                                <span>{dateStr}</span>
                                            </div>
                                        </div>
                                        {activity.notes && (
                                            <div class="mt-3 pt-3 border-t border-white/5">
                                                <p class="text-slate-400 text-sm italic">"{activity.notes}"</p>
                                            </div>
                                        )}
                                    </div>
                                );
                            })
                        )}
                    </div>
                    
                    {/* Bottom Nav */}
                    <div class="fixed bottom-0 left-0 right-0 z-50 bg-[#1C1E21] border-t border-white/5">
                        <div class="flex items-center justify-around h-16">
                            <button onClick={() => navigate('dashboard')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">dashboard</span>
                                <span class="text-[10px] font-medium">Home</span>
                            </button>
                            <button onClick={() => navigate('clients-list')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">people</span>
                                <span class="text-[10px] font-medium">Clients</span>
                            </button>
                            <button onClick={() => navigate('analytics')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">bar_chart</span>
                                <span class="text-[10px] font-medium">Analytics</span>
                            </button>
                            <button onClick={() => navigate('settings')} class="flex flex-col items-center justify-center gap-1 p-2 text-slate-400 hover:text-slate-300">
                                <span class="material-symbols-outlined">settings</span>
                                <span class="text-[10px] font-medium">Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
